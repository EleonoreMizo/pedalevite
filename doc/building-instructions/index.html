<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Pédale Vite v2&nbsp;&mdash;&nbsp;pédalier multi-effet pour guitare et basse&nbsp;&mdash;&nbsp;Instructions de montage</title>
<link rel="stylesheet" type="text/css" href="style.css" />
</head>

<body><div class="global">

<h1>Pédale Vite v2&nbsp;&mdash;&nbsp;Instructions de montage</h1>

<h2>Table des matières</h2>

<ol style="list-style-type:upper-roman;">
<li class="tcont"><a href="#intro">Introduction</a></li>
<li class="tcont"><a href="#requirements">Fournitures</a>
	<ol style="list-style-type:decimal; margin-top:0.5em;">
	<li><a href="#req-drawings">Plans</a></li>
	<li><a href="#req-material">Matériaux</a></li>
	<li><a href="#req-tools">Outillage</a></li>
	</ol>
</li>
<li class="tcont"><a href="#stepbystepbuilding">Montage pas à pas</a>
	<ol style="list-style-type:decimal; margin-top:0.5em;">
	<li><a href="#build-box">Boîtier</a></li>
	<li><a href="#build-elec">Électronique</a></li>
	<li><a href="#build-asm">Assemblage</a></li>
	</ol>
</li>
<li class="tcont"><a href="#softwareinstall">Installation logicielle</a>
	<ol style="list-style-type:decimal; margin-top:0.5em;">
	<li><a href="#soft-prepare">Préparation du système</a></li>
	<li><a href="#soft-startup">Démarrage et mise à jour système</a></li>
	<li><a href="#soft-baseconf">Configuration de base</a></li>
	<li><a href="#soft-opt-startup">Optimisation du temps de démarrage</a></li>
	<li><a href="#soft-install-dep">Installation des dépendances logicielles</a></li>
	<li><a href="#soft-install-clang">Installation de Clang (facultatif)</a></li>
	<li><a href="#soft-install-app">Installation de Pédale Vite</a></li>
	<li><a href="#soft-autorun">Démarrage automatique de Pédale Vite</a></li>
	<li><a href="#soft-ro">Passage du système en lecture seule et autres optimisations</a></li>
	</ol>
</li>
<li class="tcont"><a href="#maintenance">Maintenance</a></li>
	<ol style="list-style-type:decimal; margin-top:0.5em;">
	<li><a href="#troubleshooting">Tests et dépannage</a></li>
	<li><a href="#source">Code source</a></li>
	</ol>
<li class="tcont"><a href="#improvements">Amérliorations et variations envisageables</a></li>
<li class="tcont"><a href="#changelog">Historique des versions</a></li>
</ol>


<h2><a id="intro"></a>I.&emsp;Introduction</h2>

<p><i>Pédale Vite</i> est une pédalier multi-effet pour guitare à fabriquer
soi-même (DIY, <i><span lang="en">do it yourself</span></i>).
Ce manuel détaille comment réaliser le montage et installer toutes les
composantes nécessaires à son fonctionnement.</p>
<p>Ce projet est relativement complexe et modérément difficile, mais à la
portée de tout le monde.
Il n’est pas nécessaire d’avoir le bricolage dans le sang.
Il ne nécessite pas d’adresse ou de compétence particulière.
Les techniques utilisées (soudure, perçage, etc.) ne s’improvisent pas mais
s’apprennent relativement rapidement.</p>
<p>Cependant la réalisation est relativement prenante et nécessite une dizaine
de jours de travail environ.
C’est approximativement le temps que j’ai passé au montage.
Je suis loin d’être très organisé et encore moins adroit de mes dix doigts.
Je suis sûr qu’une personne un peu bricoleuse peut réduire ce temps de
moitié.</p>
<p>Il est préférable de lire les instructions dans leur intégralité avant
de commencer, afin de se faire une idée plus précises des opérations et de
leur ordre.
Il n’y a pas beaucoup d’illustrations des étapes intermédiaires du montage,
mais celles illustrant le pédalier (presque) fini devraient suffir à se faire
une idée plus précise des placements et de la logique d’assemblage.</p>



<h2><a id="requirements"></a>II.&emsp;Fournitures</h2>

<p>Les fichiers nécessaires se trouvent dans le
<a href="https://github.com/EleonoreMizo/pedalevite/">dépôt GitHub</a> du
projet.</p>
<ul>
<li>Les schémas en <code>.pro</code> s’ouvrent avec <a href="http://kicad-pcb.org/">KiCAD</a>, utilisé ici en version 6.0.2.</li>
<li>Les dessins en <code>.dfx</code> s’ouvrent avec <a href="http://librecad.org/">LibreCAD</a>, utilisé ici en version 2.2.0.</li>
<li>Les feuilles de calcul <code>.ods</code> s’ouvrent avec <a href="https://www.libreoffice.org/">LibreOffice</a> ou <a href="https://www.openoffice.org/">OpenOffice</a>.</li>
</ul>
<p>Certains documents ont été exportés en <code>.png</code> ou
<code>.pdf</code> pour un accès plus simple.</p>



<h3><a id="req-drawings"></a>Plans</h3>

<p>Les plans se trouvent dans le répertoire
<a href="https://github.com/EleonoreMizo/pedalevite/tree/master/doc"><code>doc</code></a>
du dépôt.</p>
<ul>
<li>Le dossier <code>boards</code> contient les schémas électroniques (KiCAD)
ainsi que les plans des ciruits imprimés des différentes cartes.</li>
<li><code>drawing-panel.dxf</code> donne le plan de perçage des feuilles
métalliques composant le boîtier.</li>
<li><code>cables.ods</code> fournit le plan de câblage.
Chaque paire de lettre indique les broches à relier ensemble au moyen d’un fil
électrique.</li>
</ul>
<p>Ces plans ne sont pas exhaustifs.
Par exemple, je n’ai pas encore fait figurer les câbles reliant le Pi à son
alimentation, ou les câbles secteur.
Toutefois ce sont des parties relativement simples qui ne nécessitent pas
d’instruction détaillées.</p>



<h3><a id="req-material"></a>Matériaux</h3>

<p>La liste des matériaux utilisésse trouve dans le fichier
<code>doc/bom.ods</code> du dépôt.
Les composants sont décrits en fonction de leurs contraintes physiques et
qualitatives, assortis des d’un prix hors taxes indicatif.
D’ailleurs, en terme de prix, il est possible d’optimiser un certain nombre de
choses.
Certaines pièces sont issues de mes stocks venant de projets précédents et
peuvent avoir été achetées par lots surnuméraires.
En cherchant, on peut trouver des lots en quantités plus adéquates.
Il est tout à fait possible de prendre d’autres matériaux, pourvu qu’ils
soient compatibles ou adaptables.</p>
<p>Pour information, les résistances utilisées sont toutes des ¼&#8239;W de
6,2&#8239;mm de long au maximum, essentiellement pour des raisons
d’encombrement sur le circuit.</p>



<h3><a id="req-tools"></a>Outillage</h3>

<ul>
<li>Crayon à papier ou mieux, porte-mine pour pouvoir tracer à travers un trou de plaque</li>
<li>Compas de précision ou forme permettant de tracer des cercles de 10, 11, 12 et 24&#8239;mm de diamètre si on utilise une fraise conique sans étage</li>
<li>Réglet gradué</li>
<li>Rapporteur</li>
<li>Ciseau à bois</li>
<li>Scie à bois</li>
<li>Scie à métaux</li>
<li>Lime à métaux, plate</li>
<li>Lime à métaux à section arrondie («&#8239;queue de rat&#8239;») et aussi fine que possible (3–5&#8239;mm)</li>
<li>Établi</li>
<li>Paire de serre-joints</li>
<li>Planches jetables (récupération de palette) pour support de perçage, guides, etc.</li>
<li>Perceuse, si possible sur colonne</li>
<li>Mèche bois 2&#8239;mm</li>
<li>Mèches, cloches ou fraises coniques pour percer du 3, 4, 5, 7, 10, 11, 12 et 24&#8239;mm de diamètre dans de l’acier</li>
<li>Pointeau ou vis pointue</li>
<li>Mini-perceuse type Dremel</li>
<li>Disques de tronçonnage pour acier (si possible plusieurs, petits et grands diamètres)</li>
<li>Huile de coupe</li>
<li>Jeu de clés plates ou éventuellement à pipe&#8239;: 5, 5.5, 6, 10, 13 et 14&#8239;mm</li>
<li>Tournevis plat</li>
<li>Tournevis cruciforme ordinaire (PH2 et possiblement PH1)</li>
<li>Marteau</li>
<li>Fer à souder thermorégulé avec porte-fer (50&#8239;W mini)</li>
<li>Fil de soudure 0.5&#8239;mm et 1&#8239;mm avec flux</li>
<li>Pompe à soudure et éventuellement de la tresse à déssouder</li>
<li>Troisième main</li>
<li>Étau</li>
<li>Éponge dédiée au nettoyage du fer</li>
<li>Pinces à bec fin</li>
<li>Pinces brucelles</li>
<li>Pinces à couper les pattes de composants (pinces coupantes ordinaires O.K. mais moins pratiques)</li>
<li>Pinces à sertir les petites cosses (les <a href="http://www.engineer.jp/en/products/pa09e.html">PA-09</a> de chez Engineer sont très bien)</li>
<li>Pinces à sertir les cosses Faston 250</li>
<li>Outil à dénuder de petit calibre</li>
<li>Ruban adhésif isolant («&#8239;Scotch d’électricien&#8239;»)</li>
<li>Gants</li>
<li>Lunettes de protection contre les projections</li>
<li>Masque respiratoire contre la poussière</li>
<li>Multimètre (mesure de résistance ou de contact)</li>
<li>Oscilloscope (facultatif mais pratique)</li>
<li>Markers pas trop gros clairs et foncés ou tubes de peinture avec pinceau fin</li>
</ul>

<p>Cette liste n’est pas complètement exhaustive, n’y figurent pas tous les
petits outils ou matériaux pouvant servir de leviers, cales ou de martyrs
durant le montage.
Ils peuvent être improvisés sur place en fonction de ce dont vous disposez et
de vos habitudes ou techniques de bricolage.
L’outillage à lui seul peut revenir assez cher.
N’hésitez pas à vous faire prêter le matériel, ou à faire des achats
collectif.</p>



<h2><a id="stepbystepbuilding"></a>III.&emsp;Montage pas à pas</h2>



<h3><a id="build-box"></a>Boîtier</h3>

<h4>Usinage</h4>

<p>En premier lieu, protégez-vous le visage, les yeux et les mains avec
les lunettes et les gants.
Le masque sert aussi à se protéger contre l’inhalation des poussières.
Si possible, portez des vêtements couvrants.</p>
<p>Découper la plaque de métal avec la scie à métaux ou avec un disque de
tronçonnage monté sur la mini-perceuse.
Dans ce dernier cas, utiliser une planche comme guide pour appuyer l’axe de
l’outil afin de couper aussi droit que possible.
Asperger la ligne de coupe d’huile de coupe afin d’éviter les échauffements
et d’économiser les disques de tronçonnage.</p>
<p>Les plaques sont à découper aux dimensions suivantes&#8239;:</p>
<ul>
<li>Façade (dessus)&#8239;: 520&#8239;×&#8239;250&#8239;mm²</li>
<li>Face arrière&#8239;: 520&#8239;×&#8239;70&#8239;mm²</li>
<li>Face avant&#8239;: 520&#8239;×&#8239;30&#8239;mm²</li>
<li>Dessous&#8239;: 520&#8239;×&#8239;253&#8239;mm²</li>
<li>Côtés: [30–70]×250mm² (trapèze rectangle)</li>
</ul>
<p>Note&#8239;: la face avant et le dessous peuvent être en aluminium car elles
nécessitent moins de robustesse.</p>
<p>Une fois les panneaux coupés aux bonnes dimensions, ébavurer avec une lime de
façon à arrondir les bords dans le sens de l’épaisseur.</p>
<p>Important&#8239;: toutes les opérations se font sur la face intérieur de chaque
panneau.
Les plans sont tous des vues de l’intérieur.</p>
<p>Tracer ensuite les repères des perçages et découpes en fonction des plans.
Tracer le contour des trous à percer à la fraise conique à l’aide d’un compas.
Marquer le centre des trous avec un pointeau ou une vis bien pointue.
Procéder ensuite au perçage.
Pour les trous les plus gros, il peut être intéressant de faire un avant-trou
afin de bien guider la mèche ou la fraise.
Utiliser l’huile de coupe.
Avec la fraise conique, arrêter la découpe quand on dépasse les contours tracés.
Se munir de la pièce à faire rentrer dans le trou et essayer.
Remettre un coup de fraise si c’est trop juste, ou limer.</p>
<p>Une fois les plus gros trous faits, ébavurer avec une fraise spéciale ou
utiliser la mini-perceuse avec un disque de tronçonnage pour découper le métal
qui dépasse.</p>
<p>Découper deux morceaux de 520&#8239;mm dans la cornière.
Ils viendront faire la jonction aux angles supérieurs du boîtier.
La partie la plus courte du L sera sur le dessus et la plus longue verticale.
Si nécessaire, ronger la partie supérieure d’une des cornières avec la queue
de rat afin de laisser la place pour les deux vis de l’écran.</p>
<figure>
  <a href="display-outside.jpg"><img src="display-outside-small.jpg" /></a>
  <figcaption>De la place pour les vis.
En fait ce n’était pas vraiment nécessaire.</figcaption>
</figure>
<p>Découper deux autres morceaux de cornière de 250&#8239;mm qui serviront de
renforts dans le sens de la profondeur.
Une des cornière est enjambée par la carte son.
Veiller à ce que celle-ci ne rentre pas en contact une fois en place.
Il sera peut-être nécessaire de découper un morceau&#8239;; utiliser pour
cela une lime si la quantité de matière à retirer est peu importante, sinon un
disque de tronçonnage.</p>
<p>Serrer ensemble ces deux cornières de renfort avec la plaque.
Percer d’un coup les trous traversant les deux.</p>
<p>Percer les trous restants à la perceuse et ébavurer au besoin.
Sur le schéma, les petits trous sans diamètre indiqué font 3&#8239;mm de
diamètre.
Certains trous de fixation dépendent du matériel précis dont vous
disposez&#8239;: connecteurs, prise et interrupteur secteur, etc.
Vérifiez que les trous donnés sont cohérent avec vos matéraux, ajustez-les
le cas échéant.</p>
<p>Les trous des LED sont calibrés à 5&#8239;mm.
Il est possible de les agrandir un peu à 6&#8239;mm tout en les descendant
d’un demi-millimètre.
Cela permet de descendre la LED à la surface du boîtier tout en la rendant
rendant visible même sous incidence élevée.</p>
<figure>
  <a href="led-detail.jpg"><img src="led-detail-small.jpg" /></a>
  <figcaption>Mes trous de LED vont encore plus loin et sont légèrement ovales.</figcaption>
</figure>
<p>Nota bene: les trous pour fixer les montants latéraux et les piliers sont
légèrement décalés aux angles afin que les vis puissent se croiser plutôt
que se rentrer dedans.
Les trous en bas des piliers sont clairement excentrés.</p>
<figure>
  <a href="unaligned-screws.jpg"><img src="unaligned-screws-small.jpg" /></a>
  <figcaption>Vis non-alignées, face avant.</figcaption>
</figure>
<p>Il peut être plus pratique de laisser de côté les trous qui traverseront les
cornière longitudinales.
Ils seront percés une fois les cornière placés sur le montage.</p>
<p>Découper les zones rectangulaires.
Il peut être plus pratique de commencer par percer les coins avec une mèche
de 3&#8239;mm, à 1,5&#8239;mm de chaque coin.
Cette étape facilite la jonction des découpes.
Couper les bords avec un disque de tronçonnage de petit diamètre.
Enfin, limer les bords pour les arrondir et remettre les angles au carré.</p>

<h4>Supports latéraux</h4>

<p>Prendre une planche de 18&#8239;mm d’épaisseur, 20&#8239;mm tout au plus.
Découper deux formes en trapèze rectangle de 250&#8239;mm de long et de
largeurs 30 et 70&#8239;mm.
On peut vérifier que le dernier bord fait bien 253&#8239;mm.
Les angles droits sont sur le dessus du pédalier.</p>
<p>À l’aide d’une scie et de ciseaux à bois, découper sur les montants
les trous pour faire passer les connecteurs du Pi ainsi que les contrôles
de gain de la carte son.
Se référer aux plans pour les placements, layer <code>Structure</code>.</p>
<figure>
  <a href="connectors-rpi4.jpg"><img src="connectors-rpi4-small.jpg" /></a>
  <figcaption>Ouverture pour laisser passer les connecteurs du Pi.</figcaption>
</figure>
<p>Percer ensuite les plaques métalliques latérales, positionnées côté
intérieur, et les visser.</p>
<p>Visser sur les deux formes latérales les panneaux du dessus, avant et
arrière.
Utiliser des vis à bois de 3&#8239;mm, pas trop longues.
Elles peuvent être auto-perforantes ou simples.
Dans ce cas, il vaut mieux prépercer les trous avec une mèche de 2&#8239;mm.
Placer la plaque sur les montants afin de repérer précisément les-dits trous.<p>
<p>Placer les deux cornières longitudinales aux angles, et bien les plaquer
avec des serre-joint.
Percer les trous traversant les cornières, les plaque et le bois avec une
mèche de 2&#8239;mm.
Repasser sur le métal uniquement avec une mèche de 3.</p>
<p>Il est possible de percer tous les trous des cornières, même ceux qui
tiendront les piliers centraux.
Ajouter les dernières vis des montants, ainsi que de courtes vis (8 à
10&#8239;mm) avec écrou et rondelle pour attacher la plaque du dessus aux
cornières.</p>

<h4>Piliers centraux</h4>

<p>Les piliers centraux vont servir d’appui aux deux renforts fabriqués à
partir des cornières.
Commencer par visser ces derniers à la plaque du dessus si ce n’est pas encore
fait.
Découper ensuite des piliers de 18 à 20&#8239;mm de section carrée dans du bois
solide.
On peut pafaitement reprendre des chutes de la planche ayant servi
aux supports latéraux.</p>
<p>La forme verticale des piliers (vus de côté) est légèrement trapézoidale.
La forme biseautée (9°) se trouve du côté du sol, la différence de longueur
entre les deux faces est d’environ 3&#8239;mm.</p>
<p>Couper deux piliers de 30 et 33&#8239;mm pour la face avant, et deux
piliers de 67 et 70&#8239;mm pour la face arrière.
Déduire de ces longueurs l’épaisseur de la cornière, de façon à ce que les
montants et les piliers arrivent au même niveau.
D’un autre côté, ne pas hésiter à allonger d’un demi-millimètre cette
longueur, quitte à la réajuster à la rappe plus tard, en situation.</p>
<p>Placer chaque pilier sur le montage, percer le trou dans le bois et
visser.
Poser ensuite à plat le montage et vérifier qu’il n’est pas bancal.
Limer au besoin les pieds un peu trop longs.</p>
<p>Ensuite, l’épreuve du feu&#8239;: poser le boîtier au sol et monter dessus.
Il ne doit pas se déformer ou donner des signes de faiblesse.</p>



<h3><a id="build-elec"></a>Électronique</h3>

<h4>Les cartes</h4>

<p>Les cartes principale, carte audio et convertisseur
2&#8239;&times;&#8239;15&#8239;V sont des PCB que vous pouvez faire fabriquer
à l’aide des fichiers Gerber situés dans les sous-répertoires de
<code>doc/boards</code>.
Il est aussi possible de récupérer des restes de mes plaques à prix
coûtant, me contacter directement si vous êtes intéressé·e.</p>
<p>Pour les autres cartes, découper les rectangles suivants dans la plaque de
prototypage&#8239;:</p>
<ul>
<li>19&#8239;&times;&#8239;18 trous entiers, soit &nbsp;&nbsp;48,3&#8239;&times;&#8239;45,7&#8239;mm², carte de l’alimentation 5&#8239;V</li>
<li>20&#8239;&times;&#8239;13 trous entiers, soit &nbsp;&nbsp;50,8&#8239;&times;&#8239;33,0&#8239;mm², carte des boutons de navigation</li>
<li>18&#8239;&times;&#8239;&nbsp;&nbsp;4 trous entiers, soit &nbsp;&nbsp;45,7&#8239;&times;&#8239;10,1&#8239;mm², carte des diodes</li>
<li>18&#8239;&times;&#8239;&nbsp;&nbsp;4 trous entiers, soit &nbsp;&nbsp;45,7&#8239;&times;&#8239;10,1&#8239;mm², carte des codeurs incrémentaux de navigation</li>
<li>48&#8239;&times;&#8239;&nbsp;&nbsp;3 trous entiers, soit 121,9&#8239;&times;&#8239;&nbsp;&nbsp;7,6&#8239;mm², carte des codeurs incrémentaux de paramètres</li>
</ul>
<p>Les plaque de prototypage standard font 61 trous sur 38.
Il est donc possible d’extraire toutes les cartes d’une seule plaque.
On peut prendre des plaques à bandes ou à pastilles, ces dernières étant
probablement plus pratiques pour les circuits à réaliser.</p>
<p>On peut utiliser une simple scie à métaux, qui fait très bien l’affaire.
Immobiliser la plaque sur un établi avec un étau ou un serre-joint,
en la coinçant entre deux planchettes de bois pour ne pas l’abîmer.
La découpe se fera au milieu d’une rangée de pastilles, pour profiter
des trous existants.</p>
<p>Percer des trous de fixation aux endroits indiqués sur le fichier de PCB
(<code>doc/boards/misc-boards/misc-boards.kicad_pcb</code>) à l’aide d’une
mèche de 3&#8239;mm.
Sans perceuse à colonne, il est préférable de percer au centre d’une pastille,
là ou le petit trou fait office de guide.
Chaque trou sera fait au milieu d’un carré de 3&#8239;&times;&#8239;3
pastilles, sur lesquelles aucun câblage ne pourra être fait.</p>
<p>Après le découpage de la carte des LED, il faut fabriquer le support avant
de souder les composants.
Voir plus bas.</p>
<p>Il est aussi possible de faire graver ces cartes sous forme de PCB en
extrayant et exportant les PCB «&#8239;secondaires&#8239;» de
<code>doc/boards/main-board</code>.
Toutefois ces cartes sont très simples et je ne pense pas qu’il soit
intéressant de les faire fabriquer.</p>

<h4>Soudure des PCB</h4>

<h5>Carte principale</h5>

<p>Souder les composants par ordre de hauteur.
D’abord les résistances à plat, puis tous les condensateurs céramique situés
hors des supports à circuits intégrés.</p>
<p>Vérifier ensuite que les supports et les condensateurs internes peuvent
cohabiter sans problème.
Le cas échéant, raboter à la lime le plastique des supports afin que tout
rentre correctement sans forcer.
Il est possible d’incliner les condensateurs ou de les déporter légèrement,
jusqu’à une certaine limite.</p>
<p>Souder ensuite les supports, puis les condensateurs internes.
Ensuite les résistances verticales, puis les transistors.
Viennent enfin les connecteurs HE10, Dupont et NSK254.</p>
<p>Ne posez pas tout de suite les puces dans leur support, il y des
vérifications à faire avant, voir plus bas.</p>

<h5>Carte audio</h5>

<p>Cette carte demande une certaine attention.
En effet, il y a deux composants montés en surface (CMS), le codec CS4272 et
l’horloge MK2703.
Le CS4272 est particulièrement délicat puisqu’il s’agit d’un boîtier TSSOP,
aux pattes très fines (0,63&#8239;mm de pas).
Ces deux composants sont à souder en premier.
Il vous faudra du fil à soudure fin (0,5&#8239;mm), et en fonction de votre
acuité visuelle, peut-être une loupe ou un microscope.
Un très bon éclairage est nécessaire dans tous les cas.</p>
<p>Il existe diverses techniques de soudure de ce type de composant,
impliquant généralement de commencer par souder deux pattes pour immobiliser
la pièce, puis de souder le reste.
Il existe de nombreux guides en photo ou vidéo pour la soudure manuelle de
puces CMS.
La technique par innondation de soudure marche relativement bien, mais demande
un minimum de pratique pour être propre et efficace.
N’hésitez pas à vous entraîner au préalable sur des plaques-adaptateurs avec
des puces bon marché qui pourront être sacrifiées sans regret.
Sinon revenez à la technique la plus simple, patte par patte.
Le plus gros risque est de faire couler de la soudure sous la puce, derrière
les pattes et de les court-circuiter sans qu’il ne soit possible de revenir en
arrière.
En cas de problème, il est quasiment impossible de déssouder la puce sans
l’endommager (mécaniquement ou thermiquement) et de recommencer, sauf si vous
disposez d’un pistolet à air chaud adapté.</p>
<p>Si vous ne vous sentez pas suffisamment en confiance pour l’opération,
confiez-la à une personne expérimentée ou professionnelle.
Toutefois, ce n’est pas si difficile, cette carte fut ma première expérience
de soudure de puce TSSOP et elle fonctionne très bien.</p>
<figure>
  <a href="board-audio.jpg"><img src="board-audio-small.jpg" /></a>
  <figcaption>La carte audio complètement montée et branchée.</figcaption>
</figure>
<p>Après avoir soudé les puces CMS, on soude les composants dans leur ordre de
hauteur&#8239;: les petites diodes type 1N4448, les résistances, les diodes
plus grosses type Schottky, les condensateurs céramique, les supports de
circuits intégrés, les condensateurs film, les connecteurs Dupont et supports
tulipe pour transistors et régulateurs, les selfs, la ferrite, et finalement
sans ordre prédéfini, les condensateurs électrolytiques, le régulateur
5&#8239;V, le connecteur NSK254 de l’alimentation.</p>
<p>Placez le quartz dans cette liste en fonction de sa taille, mais avant de
souder celui-ci, assurez-vous qu’il y a un espace entre le composant et le
PCB.
Vous pouvez intercaler un morceau de carton pour assurer l’écart et le
retirer une fois la soudure effectuée.
Attention à ne pas le faire trop chauffer, il pourrait brûler.</p>
<p>Les transistors Q1–Q3, la référence de tension D9 et le régulateur IC4
sont montés sur support tulipe plutôt que soudés directement.</p>
<p>Positionner les self de façon à ce qu’elles soient à moitié debout, l’une
en face de l’autre pour chaque canal d’entrée, formant un angle droit.</p>
<p>Une fois que tout est soudé, fixer le radiateur sur IC3.<p>
<p>Enfin, insérer un cavalier sur JP1 pour sélectionner le bit de poids faible
de l’adresse I²C de la carte.
Le mettre entre les broches 2 et 3 pour l’adresse 0, attendue par la partie
logicielle.</p>
<figure>
  <a href="board-audio-jumper-i2c.jpg"><img src="board-audio-jumper-i2c-small.jpg" /></a>
  <figcaption>Sélection de l’adresse I²C avec JP1.</figcaption>
</figure>
<p>Comme pour la carte principale, ne pas placer tout de suite les puces dans
leur support.</p>

<h5>Carte de conversion 15&#8239;V alternatifs vers continu</h5>

<p>Pas grand-chose à dire sur cette carte qui alimente la partie analogique de
la carte son.
Ne pas oublier de fixer les radiateurs sur les régulateurs de tension.
Les self L1 et L2 sont à incliner de façon à ce qu’elles forment un angle à
90°.</p>
<figure>
  <a href="board-2x15vacdc.jpg"><img src="board-2x15vacdc-small.jpg" /></a>
  <figcaption>Redressement des ±15&#8239;V. Ne pas prêter attention aux diodes
du pont qui ne sont pas du modèle indiqué sur la liste.</figcaption>
</figure>

<h4>Soudure des plaques de prototypage</h4>

<p>Pour toutes les cartes&#8239;: côté composants, commencer par placer sans
les souder les principaux composants à l’aide du schéma PCB.
En marquer le tour au crayon à papier.
On obtient ainsi des repères pour les placements.</p>

<h5>Création des pistes</h5>

<p>Pour connecter les composants entre eux sur une plaque à pastilles, il peut
être nécessaire de créer des pistes, côté cuivre.
Ces pistes apparaissent sur les schémas en vert (calque <code>B.Cu</code>,
<span lang="en"><i>back copper layer</i></span> dans KiCAD/Pcbnew).
Pour m’aider, j’ai pris une capture d’écran du schéma de montage, qu’on voit
habituellement côté composants.
Avec un éditeur d’images, je l’ai retournée en miroir dans le sens horizontal
afin d’avoir le plan de câblage dans le bon sens.</p>
<p>Pour créer la piste, on peut utiliser des ponts avec de la soudure, ou
prendre du fil de cuivre nu.
Dans ce cas utiliser plutôt du fil monobrin, préférablement étamé, ce sera
plus facile.
On peut aussi réutiliser des chutes de pattes de composants, ce qui est
sûrement la solution la plus judicieuse ici.</p>
<p>Avec du fil monobrin, dérouler un peu de câble.
Tirer dessus avec une pince d’une main et la bobine dans l’autre main jusqu’à
ce qu’une légère élongation se fasse sentir&#8239;; arrêter immédiatement pour
éviter de rompre le fil.
Il devrait alors être bien droit.
En couper un peu plus que la longueur désirée.</p>
<p>Pour le poser le fil de piste, partir de la pastille libre la plus proche,
faisant partie du trajet.
À l’aide d’une pince, plier l’extrémité du fil sur 1 ou 2&#8239;mm de façon à
faire un petit crochet qui rentrera dans le trou d’extrémité.
Plier ensuite le fil pour effectuer le chemin désiré.
Pour mesurer les sections de la piste, s’aider d’un gabarit, par exemple en
prenant les chutes de la plaque pour s’en servir de règle graduée en pastilles.
Quand le chemin est complexe, on peut faire un contrôle de temps en temps en
posant la piste sur la plaque et en ajustant.
À la fin, refaire un crochet, faire les derniers ajustements et couper le bout
excédentaire.</p>
<p>Bien regarder ce qui passe sur le trajet, il peut être nécessaire de
s’écarter un peu du centre des pastilles pour laisser la place à des pattes
de composant.
De même, éviter de faire partir le fil directement de l’emplacement d’une
patte, la soudure à cet endroit empêchera l’insertion du futur composant
sans compter qu’il n’y aura peut-être pas assez de place pour les deux.</p>
<p>Souder aux extrémités et aux angles.
Rajouter des points de soudure sur les portions un peu longues, pour
consolider.</p>
<p>Lors de la soudure des composants, il faudra faire un petit pont pour
relier la piste à la patte du composant.</p>

<h5>Fils de connexion côté composants</h5>

<p>Certaines plaques ont besoin d’avoir des fils de connection, côté
composants.
Prendre du fil isolé et le dénuder sur 2–3&#8239;mm auparavant.
Coincer le fil dans la plaque avec une pince crocodile.
Ne pas mordre directement à l’emplacement de la soudure.
Faire plutôt une sorte de U renversé en plaquant le fil un peu plus loin et
en le faisant rentrer verticalement.
En gros, la pince doit exercer sur le fil une pression verticale légère pour
le maintenir contre le trou et tenter de le faire rentrer plus loin (il est
bloqué par sa gaine).
Quand le fer va chauffer le fil, l’isolant va se rétracter un petit peu et le
fil va avancer.
Cette méthode permet d’avoir la gaine qui descend aussi bas que possible, ce
qui est nécessaire pour éviter les court-circuits entre plusieurs fils plantés
les uns à côté des autres.</p>

<h5>Carte d’alimentation 5&#8239;V</h5>

<p>Souder les borniers puis le bloc d’alimentation.
Relier les pattes en soudant des fils de cuivre nu ou en posant de grands
ponts de soudure.
Se référer au schéma de PCB pour placer ces pistes.</p>
<p>Certaines pistes et broches (J501 et les broches 1 et 2 du bloc) véhiculent
des tensions secteurs.
Il sera nécessaire de gratter soigneusement le cuivre autour de ces pistes sur
au moins une pastille de large (2,5&#8239;mm) afin d’éviter toute possibilité
de court-circuit.
Une mini-perceuse munie d’une petite fraise arrondie est parfaite pour ce
travail.
Bonus&#8239;: recouvrir ces pistes et broches de vernis.</p>
<p>De même, faire attention aux trous de montage.
Veiller à ce que les écrous, rondelles et entretoises restent suffisamment
éloignées des pistes secteur.</p>

<h5>Carte des boutons de navigation</h5>

<p>Sur cette carte, les boutons sont sur le côté cuivre et le connecteur côté
composants.
Il y a deux approches possibles.
La première consiste à utiliser le cuivre de la carte pour y faire certaines
connexions, la masse par exemple.
Cette option est relativement simple si on utilise une Veroboard plutôt qu’une
plaque à pastilles&#8239;; il suffit de couper les pistes aux bons endroits.
C’est la solution que j’ai retenue car je disposais de chutes de Veroboard.
Dans le cas d’une plaque à pastilles, il faut constituer des pistes en
ajoutant du fil de cuivre nu ou des ponts de soudure.
Ces éléments conducteurs vont alors se retrouver sous les boutons.
Veiller à ce que les boutons, une fois en place, reposent de manière stable
et horizontale sur les pistes.
De plus, il faudra veiller à laisser des trous ouverts pour insérer les pattes
de ces boutons, ce qui peut être compliqué.</p>
<p>La deuxième option consiste à tout câbler côté composants avec du fil
isolé.
Dans ce cas, commencer avec les éléments près du connecteur, car le câblage va
devenir assez dense à cet endroit.</p>
<p>Souder les boutons rangée par rangée, un par un, par le dessus.
Souder entre deux boutons peut être un peu délicat, faire attention à ne pas
faire fondre le plastique en baladant le fer.
Veillez à ce que les boutons soient bien plaqués à la carte lors de la
soudure.
En effet, ils vont devoir encaisser des pressions importantes et régulières,
et cela ne doit pas faire travailler les soudures.</p>
<p>Il n’est pas nécessaire de relier toutes les pattes.
Chaque bouton en a quatre, elles sont reliées deux à deux en interne,
constituant deux uniques pôles.
Il suffit de souder et de connecter une patte de chaque pôle.
En fonction de la solution de connexion retenue, souder les câbles au fur et
à mesure, ou après soudure de l’ensemble des boutons.
À vous d’évaluer ce qui va être le plus pratique à faire.
Sur le connecteur, il n’y a que deux pattes de masse pour les six boutons,
il vous faudra donc faire des dérivations.</p>
<figure>
  <a href="board-nav-switches.jpg"><img src="board-nav-switches-small.jpg" /></a>
  <figcaption>Carte des boutons de navigation, côté composants.<br />
Ici, une plaque à bandes (Veroboard) a été utilisée pour simplifier le
câblage.<br />
Les fils sont soudés des deux côtés pour des raisons pratiques.</figcaption>
</figure>

<h5>Cartes des codeurs incrémentaux</h5>

<p>Comme pour les boutons, la soudure des codeurs se fait côté cuivre.
Idéalement il faudrait fixer les codeurs sur la plaque de façade et les souder
une fois en place.
On s’assure ainsi que le positionnement est bon par rapport au perçage.
Cependant l’espace entre les codeurs et la plaque est réduit, ce qui peut
rendre la manipulation ardue.</p>
<p>S’il est trop compliqué de faire ainsi, souder les composants au mieux,
puis vérifier le placement sur la façade.
Si nécessaire, agrandir avec une lime de section arrondie les trous qui
nécessitent un réajustement.</p>
<p>Faire la liaison entre les connecteurs et les codeurs à l’aide de ponts
de soudure.
Pour les deux codeurs à boutons, ajouter côté composants des fils isolés
reliant le connecteur aux deux bornes de l’interrupteur.</p>
<figure>
  <a href="board-rot-enc-param.jpg"><img src="board-rot-enc-param-small.jpg" /></a>
  <figcaption>Codeurs incrémentaux, paramètres</figcaption>
</figure>
<figure>
  <a href="board-rot-enc-nav.jpg"><img src="board-rot-enc-nav-small.jpg" /></a>
  <figcaption>Codeurs incrémentaux, navigation</figcaption>
</figure>

<h5>Carte des LED</h5>

<p>La carte des LED est un peu spécifique car d’une part elle est double
face et d’autre part elle est accompagnée d’un support.</p>
<p>Le support sert à retenir les LED.
Il est plaqué contre la façade, par le dessous.
Compte tenu des dimensions des LED que j’ai utilisées, le support doit être
une plaque d’environ 2&#8239;mm d’épaisseur.
Ici, j’ai pris un reste d’aluminium de 2,5&#8239;mm.
Cependant ces LED au format plat semblent difficiles à trouver aujourd’hui.
Si les vôtres sont plus hautes (c’est le cas des LED standard), on peut
prendre une plaque de 3–5&#8239;mm.
L’essentiel, c’est que les LED ne dépassent pas du boîtier, ou à peine.
Elle peut être en bois, en plastique ou dans n’importe quel autre matériau
suffisamment robuste.
Ses dimensions doivent correspondre à peu près à celle de la carte.
Elle peut être plus grande, mais il faudra veiller à ce qu’elle ne rentre
pas en collision avec un autre élément du boîtier.</p>
<p>Une fois le support prêt, attacher la carte dessus avec un serre-joint,
le côté cuivre.
Percer les trous de fixation.
Ce procédé garantit que les trous seront bien en face les uns des autres.
Puis, en maintenant carte et support attachés, marquer sur ce dernier à l’aide
d’une mine les trous dans lesquels seront placées les pattes des LED.</p>
<p>Détacher le support et marquer le centre de chaque LED.
Percer les trous d’accueil de ces LED, d’un diamètre de 5&#8239;mm.
Il faut être précis car en terme d’esthétique, le moindre écart va être
visible.
Vérifier ensuite l’alignement avant et après perçage avec le panneau du dessus
du boîtier.</p>
<p>On passe ensuite les LED sur le circuit, toujours sans les souder.
On assemble tout&#8239;: la plaque dans laquelle on coince la tête des LED,
le circuit qui leur tient les pattes, et les boulons avec leur entretoise
qui maintiennent les deux supports à distance suffisante.</p>
<p>Il faut choisir les entretoises pour laisser de la place entre le circuit
et la base de la tête des LED.
En effet, les LED sont fixées côté pastilles, et à moins d’avoir une plaque
double face, il faudra souder de ce côté, entre la plaque et les têtes.
Des entretoises de 5&#8239;mm conviennent bien, mais on peut aussi en
prendre de 10&#8239;mm si la soudure par l’intérieur semble trop difficile.
Au besoin, ajuster la hauteur avec des rondelles.
S’assurer également de disposer de vis de longueur suffisante, en comptant
les épaisseurs du panneau et des diverses rondelles.</p>
<p>Bien aligner les LED avant de les souder.
Une fois les LED fixées, on peut démonter la plaque.
Souder les pistes et le reste des composants.
On peut aussi faire les opérations dans l’ordre inverse, ça n’a pas vraiment
d’importance.</p>
<figure>
  <a href="led-board.jpg"><img src="led-board-small.jpg" /></a>
  <figcaption>Montage ayant servi au prototype de Pédale Vite</figcaption>
</figure>
<figure>
  <a href="led-board-mounted.jpg"><img src="led-board-mounted-small.jpg" /></a>
  <figcaption>Carte LED, montée.</figcaption>
</figure>

<h4>Test des connexions</h4>

<p>Avant de fixer les circuits intégré, il faut tester les connexions.
Utiliser un multimètre en mode testeur de fils ou ohm-mètre.
C’est important de le faire avant de fixer les circuits ingégrés ou les
connecteurs, parce que les circuits peuvent avoir des contacts internes qui
vont venir fausser les mesures.</p>
<p>Avoir devant soi un plan récapitulant les broches de chaque connecteur.
Pour chacun d’entre eux, vérifier les choses suivantes&#8239;:</p>
<ul>
<li>Pour chaque broche de masse, vérifier qu’aucune autre broche n’est en
contact avec elle, sauf peut-être d’autres broches de masse.</li>
<li>Idem pour les broches d’alimentation, vérifier sur les supports des
circuits intégrés que ces broches aboutissent bien.
On retrouvera tout de même des connexions avec d’autres broches
via les résistances de tirage (<span lang="en"><i>pull-up</i></span>).
Vérifier que ça arrive sur les boutons, et vérifier les résistances
indiquées.</li>
<li>Pour chaque paire de broches voisines, vérifier qu’il n’y ait pas
de contact, ou alors que les résistances indiquées soient cohérentes.</li>
<li>Quand il y a deux paquets de soudure suspects l’un à côté de l’autre sur
la plaque, vérifier qu’ils ne sont pas en contact.</li>
<li>Pour les autres broches type GPIO, vérifier qu’elles sont connectées aux
bonnes broches sur les supports ou connecteurs.</li>
<li>En bonus, on peut trituer les fils isolés lors des tests pour vérifier
que la connexion ne bouge pas.</li>
</ul>
<p>Ces tests ne donnent certainement pas une garantie de fonctionnement,
mais s’ils sont fait rigoureuseuement, permettent de débusquer la grande
majorité des erreurs et minimisent les risques de court-circuit.</p>
<p>Une fois les vérifications effectuées, on peut insérer les circuits
intégrés.
Sur ceux en boîtiers DIP, les pattes ne sont pas tout à fait verticales
et ne rentrent pas telles quelles dans les supports.
Il faudra donc achever de les plier.
Cela peut être fait patte par patte, ou d’un seul coup en prenant le
composant dans un étau à l’horizontal et en serrant très
précautionneusement les mors pour rendre les pattes bien droites.</p>

<h4>Câblage</h4>

<p>Pour relier le Pi et la carte principale, on peut prendre une nappe IDE
à l’ancienne, qui sont des HE10 de 40 broches.
Il y a souvent un détrompeur qui bouche un des trous, il suffit de le percer
avec une pointe type couteau ou ciseaux.
La broche femelle apparaît derrière.
On peut vérifier avec un multimètre et deux broches mâles que la connexion
se fait bien entre les deux trous débouchés.
Attention, il faut que ce soit une nappe de 40 fils, et surtout pas les nappes
plus récentes Ultra-DMA de 80 fils.
Leurs connexions ne sont pas équivalentes, et parfois même un fil est coupé.
En terme de connexion, le fil qui se trouve du côté de la carte micro-SD sur
le Pi doit aboutir côté gauche sur la carte principale (le repère coloré
indique la première broche).</p>
<p>Pour les autres câblages, se reporter à la feuille de calcul qui indique
qui est connecté avec qui (chaque lettre identifie un fil), avec quel type de
connecteur, et quelle longueur de câble est nécessaire.</p>
<p>Vous pouvez entortiller les câbles à plusieurs conducteurs.
Attention cependant, plus l’entortillement est prononcé, plus le câble se
raccourcit.</p>
<p>Certains connecteurs disposent de détrompeurs, il convient donc de faire
attention à ce que la partie femelle soit orientée de la même façon que la
partie mâle.
En revanche, les connecteurs Dupont ne sont pas orientés, et c’est au
branchement qu’il faut faire attention à l’orientation.
Peindre une tache de couleur sur un des angles de chaque connecteur mâle
et femelle afin de faire la correspondance facilement.</p>
<p>Certains câbles peuvent avoir des fils qui se croisent, faire bien
attention au brochage.</p>
<p>Le câblage de l’écran est spécifique, puisque trois prises sont
interconnectées.</p>
<p>Les boutons et pédales partagent quelques fils de masse.
Préparer les câbles en les sertissant d’un seul côté.
Ils seront soudés et connectés plus tard.</p>

<h5>Câblage audio et masses</h5>

<p>Les connexions audio doivent utiliser du câble blindé à double conducteur,
en plus du blindage.
Le blindage doit être relié à la masse (voir plus bas).
Les câbles multi-conducteurs qui n’ont pas de masse, comme ceux des
potentiomètres de gain, doivent êtres entortillés.
De manière générale, utiliser un câblage aussi court que possible afin
de limiter l’exposition aux parasites.</p>
<p>Pour éviter les boucles de masses et les ronflettes induites, les masses
des circuits sont câblées en étoile, ou au pire, en arborescence.
Les liaisons entre différentes «&#8239;sections&#8239;» de masse doivent être
uniques.
Sinon, cela forme des boucles.</p>
<p>Dans Pédale Vite, les masses sont organisées de la façon
suivantes&#8239;:</p>
<ul>
<li>La carte audio dispose de deux plans de masse indépendants.
L’une correspond au circuit analogique, l’autre au circuit numérique.
Ces deux masses ne devraient être connectées qu’en un seul point, le
cavalier JP2.</li>
<li>La masse de la partie analogique doit être connectée à l’extérieur
uniquement par la première entrée (gauche) de la partie jack du combo
jack-XLR.
Les fils de masse de tous les autres connecteurs doivent être débranchés à
une de leur extrémité.
Ils doivent cependant y rester connectés en un point, car la liaison à la
masse assure l’efficacité du blindage.</li>
<li>Les masses des autres connecteurs audio sont connectées au chassis,
soit naturellement dans le cas des prises jack non-isolées, soit en soudant
la broche de masse à la broche en contact avec le chassis dans le cas des
combo en plastique.
Ceci est aussi valable pour la partie XLR du combo de la première entrée.</li>
<li>Toutes les alimentations sont isolées et n’induisent pas de liaison
explicite à la masse ou à la terre.</li>
<li>La terre venant de la prise secteur est reliée au chassis, et donc à
la masse.
Idéalement il faudrait faire courir un fil allant se brancher sur la masse
de première entrée audio afin de respecter la topologie en étoile, mais
on peut considérer que la façade arrière du boîtier comme un plan de masse,
elle est suffisament conductrice.
On pourra donc connecter la terre au boîtier au niveau de l’une des vis de
la prise secteur, via une cosse.</li>
<li>Les différents panneaux du boîtier doivent être interconnectés.
Il est possible que les cornières en aluminium soient anodisées, et donc
isolantes.
Il faudra donc assurer la liaison entre tous les panneaux avec du fil et des
cosses insérées sur les vis, coincées par les écrous.
Il faudra éventuellement creuser un des piliers centraux afin de faire passer
la cosse qui fera contact avec la plaque du dessous.</li>
<li>La masse de la carte principale est reliée à celle du Pi par le connecteur
40 broches.
Cette masse est propagée à l’écran et à la partie numérique de la carte
son.
Les commutateurs sont isolés.</li>
<li>Ne souder qu’une des extrémités des fils de masse des connecteurs jack des
pédales d’expression, car ils sont déjà reliés à la masse globale par le
boîtier.</li>
<li>Les cartes dont les plans sont livrés ici ainsi que celle du Pi sont
isolées au niveau des trous de fixation, ce qui ne provoque pas de liaison
entre masse et boîtier.
Ce n’est malheureusement pas le cas de l’écran.
Il sera donc nécessaire de couper le plan de masse au niveau de chaque
«&#8239;oreille&#8239;» de fixation, des deux côtés du PCB.
Utiliser pour cela un cutter bien affûté ou l’angle d’une lime.
Vérifier au multimètre que chaque oreille se retrouve bien isolée.</li>
<li>L’écran a une double connexion avec le Pi&#8239;: une directement par le
câble HDMI, qui véhicule une masse, et l’autre par les câbles d’alimentation
et de signaux pour le capteur tactile (via la carte principale).
Là aussi une masse est véhiculée, il est préférable de ne pas la
connecter.</li>
<li>Sur la carte son, les deux masses analogique et numérique ne sont pas
explicitement reliées.
Il est possible de le faire avec un cavalier au niveau de JP2, situé près du
connecteur d’alimentation.
Une fois que tous les éléments seront installés dans le boîtier (voir plus
bas), tester avec un multimètre le contact entre les deux broches de JP2.
S’il n’existe aucun contact stable (il y a tout de même un condensateur
d’évacuation des hautes fréquences qui peut perturber le multimètre) — et ce
devrait être le cas, ajouter le cavalier.
Sinon, laisser JP2 sans cavalier.</li>
</ul>
<p>Ces considérations devraient permettre d’obtenir une masse sans boucle.</p>
<figure>
  <a href="ground-path.png"><img src="ground-path-small.png" style="border: #E0E0E0; border-style: solid; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px;" /></a>
  <figcaption>Carte des masses (traits gras).</figcaption>
</figure>
<figure>
  <a href="connectors-audio-in.jpg"><img src="connectors-audio-in-small.jpg" /></a>
  <a href="connectors-audio-out.jpg"><img src="connectors-audio-out-small.jpg" /></a>
  <figcaption>Connecteurs audio d’entrée (gauche) et de sortie (droite).<br />
Ne pas faire attention aux résistances qui ont été soudées par goût de
l’expérimentation.</figcaption>
</figure>
<figure>
  <a href="board-audio-jumper-gnd.jpg"><img src="board-audio-jumper-gnd-small.jpg" /></a>
  <figcaption>Connexion des masses analogique et numérique avec JP2 sur la
carte audio.</figcaption>
</figure>
<figure>
  <a href="enclosure-shielding-1.jpg"><img src="enclosure-shielding-1-small.jpg" /></a>
  <a href="enclosure-shielding-2.jpg"><img src="enclosure-shielding-2-small.jpg" /></a><br />
  <a href="enclosure-shielding-3.jpg"><img src="enclosure-shielding-3-small.jpg" /></a>
  <a href="enclosure-shielding-4.jpg"><img src="enclosure-shielding-4-small.jpg" /></a><br />
  <a href="enclosure-shielding-5.jpg"><img src="enclosure-shielding-5-small.jpg" /></a>
  <a href="enclosure-shielding-6.jpg"><img src="enclosure-shielding-6-small.jpg" /></a><br />
  <figcaption>Interconnexion des plaques du boîtier.</figcaption>
</figure>
<figure>
  <a href="connectors-expression-pedals.jpg"><img src="connectors-expression-pedals-small.jpg" /></a>
  <figcaption>Connecteurs des pédales d’expression.</figcaption>
</figure>
<figure>
  <a href="display-ground-1.jpg"><img src="display-ground-1-small.jpg" /></a>
  <a href="display-ground-2.jpg"><img src="display-ground-2-small.jpg" /></a>
  <figcaption>Trous de montage violemment isolés de la masse du circuit de
l’écran.</figcaption>
</figure>

<h5>Alimentation du Pi</h5>

<p>Le Raspberry Pi 4 s’alimente par une prise USB-C ou par le GPIO.
Nous allons l’alimenter par l’USB-C, la nappe reliant le GPIO n’étant
probablement pas suffisamment robuste pour véhiculer les 3&#8239;A nécessaires
à son fonctionnement.</p>
<p>Étant donné qu’il est très difficile de trouver une fiche USB-C à câbler
soi-même, nous allons prendre un cordon d’alimentation USB-A vers USB-C et le
couper.
Il suffit de conserver une quinzaine de cm depuis la prise USB-C.</p>
<p>Il s’agit ensuite d’identifier les conducteurs.
Récupérer l’autre morceau du câble, celui qui se termine par la prise USB-A,
car cette prise est plus grosse et il sera plus aisé d’en tester les broches.
<a href="https://en.wikipedia.org/wiki/USB#/media/File:USB.svg">Vu de
face</a>, les broches du connecteur orientées vers le haut, le pôle négatif
de l’alimentation se trouve tout à gauche, et le positif tout à droite.
En premier lieu, il y a de grandes chances que le blindage soit relié au pôle
négatif.
Pour le pôle +5&#8239;V, tester la continuité entre chaque fil et la broche.
Ne pas se fier à la couleur des isolants.</p>
<p>Une fois que les deux fils sont repérés, les dénuder sur 3&#8239;mm.
Les sertir de petits embouts de câblage si vous avez le matériel nécessaire,
car ces fils sont souvent assez fins et risquent de mal tenir dans les
borniers.
Sinon, dénudez plus de fils et faite un pliage avec le conducteur de façon
à avoir plus de matière.
Replier les éventuels autres fils le long du câble et les y attacher avec du
ruban adhésif isolant.</p>
<p>Enfin, connecter le câble au bornier de la carte 5&#8239;V en respectant
la polarité.</p>
<figure>
  <a href="board-5v-wires.jpg"><img src="board-5v-wires-small.jpg" /></a>
  <figcaption>Alimentation du Pi. Le câble 5&#8239;V est en blanc.</figcaption>
</figure>



<h3><a id="build-asm"></a>Assemblage</h3>

<h4>Premier assemblage</h4>

<p>On peut maintenant fixer au boîtier la plupart des éléments&#8239;:
cartes, prises, interrupteurs…
Comme le Pi est positionné très près du panneau du dessus et que son PCB est
relativement flexible, il est nécessaire de couper à ras les pattes de ses
connecteurs USB et RJ45, qui sont plus proéminents que le reste.
Le lecteur de carte micro-SD est également proeminent.
Son enveloppe est reliée à la masse et ne pose donc pas de problème, mais
elle risque de provoquer une boucle de masse si elle rentre en contact.
Pour éviter tout risque, tapisser l’endroit qui accueillera le Pi avec du
ruban adhésif isolant.</p>
<figure>
  <a href="enclosure-inside-boards-only.jpg"><img src="enclosure-inside-boards-only-small.jpg" /></a>
  <figcaption>Intérieur du boîtier sans cablage ni Pi.</figcaption>
</figure>
<p>Dans le même ordre d’idée, il faudra recouvrir d’isolant la partie de la
cornière située juste en-dessous de la carte son.</p>
<p>De même, il sera nécessaire de recouvrir d’isolant la plaque du dessous
au niveau du transformateur torique.
En effet, s’il se formait une boucle conductrice traversant le tore, ce serait
l’équivalent d’une spire en court-circuit et cela peut mettre en danger le
transformateur.</p>
<figure>
  <a href="transformer-insulation.jpg"><img src="transformer-insulation-small.jpg" /></a>
  <figcaption>Isolation de protection de la vis du transformateur, sur la
plaque du fond.</figcaption>
</figure>
<p>En parlant de transformateur, j’ai jugé nécessaire d’ajouter une grosse
rondelle sur la vis d’attache, pour éviter qu’un jour celle-ci ne traverse la
plaque sous le poids du transfo.</p>
<figure>
  <a href="transformer-washer.jpg"><img src="transformer-washer-small.jpg" /></a>
  <figcaption>Rondelle pour rigidifier la partie de la plaque soutenant le
transformateur.</figcaption>
</figure>
<p>Hauteur des entretoises nécessaires pour chaque carte&#8239;:</p>
<ul>
<li>LEDs&#8239;: 5–10&#8239;mm</li>
<li>Boutons de navigation&#8239;: 10&#8239;mm</li>
<li>Écran&#8239;: 4&#8239;mm</li>
<li>Alimentation 5V&#8239;: 5&#8239;mm</li>
<li>Raspberry Pi 4&#8239;: 3&#8239;mm</li>
<li>Carte son&#8239;: 12–13&#8239;mm</li>
<li>Carte principale&#8239;: 5&#8239;mm</li>
<li>2&#8239;×&#8239;15&#8239;V AC → DC&#8239;: 5&#8239;mm</li>
</ul>
<p>Il est sans doute préférable de ne pas monter le Pi définitivement à cette
étape.
En effet, pour installer le logiciel il sera nécessaire d’accéder à la carte
SD qui deviendra difficilement accessible une fois que tout sera monté.</p>

<h4>Câbles d’alimentation</h4>

<p>Glisser préalablement un fusible dans la cartouche, plus un de rechange.
Commencer par vérifier avec un multimètre le brochage de la prise secteur
et de l’interrupteur.
Il s’agit d’établir qui est en contact avec qui et dans quelle position.</p>
<p>Pour cette partie, prendre du câble électrique multibrin conçu pour le
secteur.
Les puissances véhiculées ne sont pas très fortes, mais il faut tout de même
une épaisseure minimale d’isolant.</p>
<p>Il y a plusieurs câbles à réaliser&#8239;: deux pour relier la phase et
le neutre entre la prise et l’interrupteur, un pour relier la terre au
boîtier, et deux pour relier l’interrupteur au module d’alimentation
5&#8239;V.
Le transformateur 15&#8239;V dispose déjà de ses câbles, qui devront être
branchés sur l’interrupteur également.
Les broches sortant de l’interrupteur devront donc accueillir deux
câbles en dérivation, l’un vers le module 5&#8239;V, l’autre vers le
transformateur.</p>
<p>Si vous disposez du matériel permettant de sertir des cosses Faston,
couper les câbles aux dimensions requises et les sertir.
Ne pas oublier de prendre les deux câbles dans la cosse pour les sorties
d’interrupteur.</p>
<p>Une fois les cosses attachées, ajouter un boîtier isolant.
Il pourra être nécessaire de légèrement plier les bornes mâles pour éviter
de toucher le fond du boîtier.</p>
<figure>
  <a href="cables-mains.jpg"><img src="cables-mains-small.jpg" /></a>
  <figcaption>Câblage secteur avec cosses Faston isolées.</figcaption>
</figure>
<p>Sans cosses Faston, il faudra souder les câbles.
Penser à glisser avant soudure deux voire trois morceaux de gaine
thermo-rétractable par contact soudé afin de ne pas laisser exposé de
conducteur secteur (sauf terre).</p>
<p>Fixer les deux sorties du transformateur dans les borniers de la carte
15&#8239;V.
Ces deux sorties doivent être branchées en série et avec la même polarité.
Sur le circuit, les deux borniers centraux sont connectées ensemble.
En cas de doute, tester le transformateur avec un multimètre.
Si la tension en série est nulle ou presque, inverser un des deux
circuits.</p>
<figure>
  <a href="board-2x15vacdc.jpg"><img src="board-2x15vacdc-small2.jpg" /></a>
  <figcaption>Secondaire du transformateur 2&#8239;&times;&#8239;15&#8239;V
connecté à la carte de rectification 2&#8239;×&#8239;15&#8239;V.</figcaption>
</figure>

<h4>Soudure des câbles des interrupteurs</h4>

<p>Il y a moins de fils de masse qui sortent des connecteurs que de fils
véhiculant du signal&#8239;: quatre pour les pédales et deux pour les
boutons de l’interface d’utilisation.
Souder les fils de masse aux interrupteurs les plus proches du connecteur
et passer la masse de proche en proche en soudant des fils intermédiaires.</p>
<p>Les interrupteurs des pédales demandent un traitement attentif et
délicat.
En premier lieu, si on utilise des DPDT, il faut partir du principe que la
position de contact de chaque interrupteur est unique.
Il n’y a pas de marque ou de signe distincif fiable donnant une orientation.
La cosse commune (masse) est au centre et c’est tout ce que l’on sait.
Il faut tester individuellement chaque interrupteur à l’aide d’un
multimètre pour connaître la paire de broche correspondant à un contact
en position enfoncée.</p>
<p>D’autre part, si le modèle d’interrupteur donné dans la liste de matériaux
est plutôt robuste, fiable, et sans problème de montage ou de soudure,
en revanche certains autres modèles peuvent se révéler assez fragiles.
Dans ce cas, lors du vissage il faut faire attention à ne pas trop appuyer sur
le boîtier plastique car celui-ci peut se disloquer ou se détacher.
Lors de la soudure, ce même boîtier plastique peut se ramollir et fondre car
la masse de métal du connecteur est importante et nécessite un apport de
chaleur significatif.
Si jamais la patte bouge dans le boîtier ramolli, le contact peut être foutu.
Il faut alors déssouder le tout et retenter sa chance sur la deuxième voie.
Tester une nouvelle fois au multimètre le fonctionnement de l’interrupteur
une fois les soudures correctement effectuées.</p>
<p>Quand tous les fils des interrupteurs sont soudés, on peut les
regrouper par connecteur.</p>
<figure>
  <a href="footswitch-wiring.jpg"><img src="footswitch-wiring-small.jpg" /></a>
  <figcaption>Connexion des commutateurs au pied.</figcaption>
</figure>

<h4>Derniers ajustements et fermeture</h4>

<p>Finir de brancher les câbles. Tous.</p>
<figure>
  <a href="board-main.jpg"><img src="board-main-small.jpg" /></a>
  <figcaption>Carte principale, hyper-branchée.<br >
Ne pas faire attention à l’inversion des fils bleu et vert sur le connecteur
audio.
Il y avait une erreur dans le prototype de la carte.</figcaption>
</figure>
<figure>
  <a href="board-audio-output.jpg"><img src="board-audio-output-small.jpg" /></a>
  <figcaption>Connecteurs de sortie sur la carte audio.
La sortie symétrique utilise la partie 1–2–3.</figcaption>
</figure>
<p>Personnellement, je n’ai pas monté les potentiomètres et boutons de gain de
la carte son car je n’en ai pas besoin pour l’instant.
À la place, j’ai utilisé des cavaliers pour sélectionner le niveau microphone
plutôt que ligne sur la prise XLR, et fixé le gain global avec une
résistance.</p>
<figure>
  <a href="connectors-missing-gain-pad.jpg"><img src="connectors-missing-gain-pad-small.jpg" /></a>
  <figcaption>La paresse l’emporta.
Pas (encore) de bouton pour les gains.</figcaption>
</figure>
<p>Pour un gain d’entrée voulu, la résistance en ohms est donné par la formule
suivante&#8239;:</p>
<p>R&nbsp;=&nbsp;2000&nbsp;/&nbsp;(G<sub>lin</sub>&nbsp;&minus;&nbsp;1)&nbsp;=&nbsp;2000&nbsp;/&nbsp;(10<sup>G<sub>dB</sub>/20</sup>&nbsp;&minus;&nbsp;1)</p>
<p>Où G<sub>lin</sub> représente le gain linéaire et G<sub>dB</sub> le même
gain exprimé en décibels.
Pour un gain unitaire, il faudrait une résistance infinie et donc laisser les
connecteurs <code>Gain pot</code> sans rien dessus.
Dans la pratique, il est plus judicieux de ne pas dépasser 10&#8239;kΩ afin
de ne pas introduire trop de bruit thermique.</p>
<p>Pour fixer la résistance, il suffit de sertir ses deux pattes avec des
fiches femelle Dupont et de les introduire dans un boîtier.</p>
<figure>
  <a href="resistor-jumper.jpg"><img src="resistor-jumper-small.jpg" /></a>
  <figcaption>Résistance dans un boîtier Dupont.</figcaption>
</figure>
<figure>
  <a href="board-audio-input.jpg"><img src="board-audio-input-small.jpg" /></a>
  <figcaption>Connecteurs d’entrée sur la carte audio.
Le niveau micro est sélectionné avec deux cavaliers, les emplacements pour les
commutateurs d’atténuation ont été laissés vides, et une résistance remplace
le potentiomètre de gain sur la première entrée.</figcaption>
</figure>
<figure>
  <a href="pedalevite-open.jpg"><img src="pedalevite-open-small.jpg" /></a>
  <figcaption>L’intérieur est fin prêt.
Sur cette version, il manque quand même le câblage de l’écran tactile.</figcaption>
</figure>
<p>Quand tout est prêt et que le boîtier peut être fermé, ajuster la cosse
de masse de la plaque du fond pour qu’elle tombe au-dessus (ou
en-dessous&#8239;?) du trou dans le pilier.
Poser la plaque.
Insérer des vis de 40&#8239;mm dans les pieds en gomme et les visser sur dans
les piliers et les angles sans trop forcer.
Le pied en gomme ne doit plus être libre de tourner, n’allez pas au-delà.
Soyez soigneux avec ces vis (ou plutôt les pas de vis des trous) car il est
possible que vous ayiez à les enlever et les remettre de nombreuses fois pour
faire les derniers ajustements et plus tard, de la maintenance.
Je vous conseille d’ailleurs de ne pas fermer le boîtier tant que le pédalier
n’est pas parfaitement opérationnel, et de retirer le Pi pour l’installation
logicielle.</p>
<figure>
  <a href="enclosure-legs.jpg"><img src="enclosure-legs-small.jpg" /></a>
  <figcaption>Huit pieds pour un boîtier.</figcaption>
</figure>
<figure>
  <a href="enclosure-back.jpg"><img src="enclosure-back-small.jpg" /></a>
  <figcaption>Arrière de Pédale Vite.</figcaption>
</figure>
<p>Si au cours de vos tests vous vous rendez compte que vous avez inversé des
pédales, des boutons, des sens de rotation des codeurs incrémentaux, il est
toujours possible de les inverser soit au niveau des câbles (il est facile de
substituer deux fils sur un connecteur), soit au niveau du logiciel.</p>
<p>Note&#8239;: le Pi 4 est connu pour chauffer beaucoup.
En cas de charge de calcul trop importante, des dispositifs internes de
protection thermique peuvent s’activer et réduire sa vitesse.
Dans le cas de Pédale Vite, toute la puissance du processeur n’est pas
utilisée.
En pratique, la température interne reste toujours en dessous de 65&#8239;°C,
selon des tests effectués à 17&#8239;°C de température ambiante avec une
charge très importante, à la limite de la stabilité (90&#8239;% d’occupation).
On peut extrapoler que jusqu’à 40&#8239;°C, il n’y a pratiquement aucun risque
que le Pi ne ralentisse sa cadence pour se préserver.
Il n’y a donc pas besoin de dispositif de refroidissement supplémentaire
(dissipateurs ou ventilateurs).</p>



<h2><a id="softwareinstall"></a>IV.&emsp;Installation logicielle</h2>

<p>Cette partie est simple mais un peu laborieuse car demandant de nombreuses
interventions manuelles.
Cependant la plupart d’entre elles peuvent être scriptées&#8239;; j’essaierai
un jour de le faire pour simplifier la tâche, mais cela demande une certaine
somme de travail.</p>



<h3><a id="soft-prepare"></a>Préparation du système</h3>

<p>Télécharger
<a href="https://www.raspberrypi.com/software/operating-systems/">Raspberry Pi
OS</a> <strong>en version Lite</strong>.
La version minimum recommandée est datée du 2019-09-26 (Buster, 32 bits).
Décompresser quelque part le fichier <code>.img</code> contenu dans
l’archive.</p>

<p>Commencer par formater la carte, si ce n’est pas déjà fait&#8239;:</p>
<ul>
<li>Aller sur le site <a href="http://www.sdcard.org/">sdcard.org</a>, rubrique
Downloads &gt; SD Card Formatter &gt; SD Formatter for Windows Download
(en ce qui me concerne).</li>
<li>Accepter la licence, télécharger l’archive, installer le programme et le
lancer.</li>
<li>Insérer la carte SD, cliquer Refresh, sélectionner le bon lecteur.</li>
<li>Cliquer sur Options, passer «&#8239;Format size adjustement&#8239;» à «&#8239;ON&#8239;».</li>
<li>Cliquer sur Format et attendre que ce soit fini. En principe c’est rapide.</li>
</ul>
<p>Sous Windows, télécharger
<a href="https://sourceforge.net/projects/win32diskimager/">Win32DiskImager</a>,
l’installer et le lancer.
Sélectionner l’image (fichier <code>.img</code>) Raspbian décompressée.
S’assurer que Device pointe sur le bon lecteur.
Cliquer sur Write, confirmer et attendre que l’image finisse d’être copiée sur
la carte.</p>
<p>Autoriser ensuite l’accès SSH dès le premier boot.
Pour cela, aller à la racine de la partition nommée boot et créer un fichier
vierge (son contenu n’a pas d’importance) intitulé <code>ssh</code>.</p>

<p>Le système est maintenant prêt à être lancé pour la première fois.
Retirer la carte Micro-SD de la machine et l’insérer dans le lecteur du Pi.
Cette étape peut être difficile si le Pi est déjà monté dans le boîtier.
Si c’est le cas, tenir la carte à l’envers à la toute extrémité d’une paire de
fines pinces à long bec.
S’armer de patience et faire glisser la carte délicatement en la collant
contre le PCB du Pi, par le dessous.
Veiller à ne pas endommager la carte.</p>
<p>Une fois ceci fait, brancher une prise réseau et l’alimentation.</p>



<h3><a id="soft-startup"></a>Démarrage et mise à jour du système</h3>

<p>Allumer le Pi, attendre un peu que le système se charge et que SSH se mette
en route.
En principe le Pi est prévu pour se faire attribuer une adresse IP par DHCP,
à vous de voir avec votre installation quelle adresse lui est donnée.
Si ce n’est pas possible, il faut brancher un écran et un clavier avant le
premier démarrage et commencer depuis le terminal local.</p>
<p>Se loguer avec les identifiants de base (<code>pi</code> /
<code>raspberry</code>).</p>

<p>Si nécessaire, on peut commencer par régler les préférences de langue et de
clavier&#8239;:</p>
<pre class="term">sudo raspi-config</pre>
<p>Sélectionner <code>5. Localisation Options</code> et
régler les préférences voulues.
Finalement, flèche gauche pour sélectionner <code>Finish</code>.
Inutile de redémarrer tout de suite même si les messages de la console vous
le conseillent.</p>

<p><strong>Important&#8239;:</strong> à partir de là, et jusqu’à la fin de
l’installation, le Pi va nécessiter d’être connecté aux internets.</p>

<p>Mettre à jour le système&#8239;:</p>
<pre class="term">sudo apt-get -y update
sudo apt-get -y dist-upgrade</pre>
<p>L’opération va prendre un peu de temps, allez donc faire quelques
<a href="http://george-abitbol.fr/v/722d9335">exercices isométriques</a> en
attendant.</p>
<p>Maintenant, on peut redémarrer:</p>
<pre class="term">sudo shutdown -r now</pre>



<h3><a id="soft-baseconf"></a>Configuration de base</h3>

<p>Commençons par faire quelques réglages.
On va avoir besoin d’activer les interfaces SPI et I2C pour
communiquer avec les différents composants nécessaires.</p>
<pre class="term">sudo nano /boot/config.txt</pre>
<p>Modifier les lignes suivantes en les commentant ou décommentant comme
suit en ajoutant ou retirant caractère <code>#</code> en début de
ligne&#8239;:</p>
<pre class="term">dtparam=i2c_arm=on
dtparam=spi=on
#dtparam=audio=on
#dtoverlay=vc4-fkms-v3d</pre>
<p>Donc on vire le son par défaut au passage.
La dernière ligne se retrouve à plusieurs endroit, faites en sorte qu’elle
soit commentée partout.
Ajouter les lignes suivantes dans la section <code>[all]</code> tout à la
fin&#8239;:</p>
<pre class="term"># Disable rainbow image at boot
disable_splash=1

# Waveshare 4 inch HDMI LCD
hdmi_group=2
hdmi_mode=87
hdmi_timings=480 0 40 10 80 800 0 13 3 32 0 0 0 60 0 32000000 3
disable_overscan=1
framebuffer_priority=2
dtoverlay=ads7846,cs=1,penirq=12,penirq_pull=2,speed=50000,keep_vref_on=0,swapxy=0,pmax=255,xohms=150,xmin=200,xmax=3900,ymin=200,ymax=3900
display_hdmi_rotate=1

# No Bluetooth, no WiFi
dtoverlay=disable-bt
dtoverlay=disable-wifi</pre>
<p>Attention, l’instruction <code>dtoverlay=ads7846…ymax=3900</code> tient sur
une seule ligne.
<code>Ctrl+X</code> pour sauver et quitter.
Ensuite on demande de charger le module I2C lors du boot&#8239;:</p>
<pre class="term">sudo nano /etc/modules</pre>
<p>Ajouter les lignes suivantes à la fin du fichier&#8239;:</p>
<pre class="term">i2c-bcm2708
i2c-dev</pre>
<p>On peut préparer le terrain pour le branchement d’un éventuel système de
stockage USB&#8239;:</p>
<pre class="term">sudo mkdir /mnt/sda1
sudo chmod 775 /mnt/sda1</pre>



<h3><a id="soft-opt-startup"></a>Optimisation du temps de démarrage</h3>

<p>Éditer le fichier&#8239;:</p>
<pre class="term">sudo nano /etc/modprobe.d/raspi-blacklist.conf</pre>
<p>Ajouter les lignes suivantes pour désactiver WiFi et Bluetooth&#8239;:</p>
<pre class="term">#wifi
blacklist brcmfmac
blacklist brcmutil
#bluetooth
blacklist btbcm
blacklist hci_uart</pre>
<p>Puis taper&#8239;:</p>
<pre class="term">sudo apt-get remove -y --purge pi-bluetooth</pre>
<p>Et on redémarre une nouvelle fois pour prendre en compte toutes les
modifications&#8239;:</p>
<pre class="term">sudo shutdown -r now</pre>



<h3><a id="soft-install-dep"></a>Installation des dépendances logicielles</h3>

<p>Installer git, Jack2, ALSA et autoconf&#8239;:</p>
<pre class="term">sudo apt-get -y install libjack-jackd2-dev libasound2-dev \
    wiringpi git git-core autoconf \
    raspberrypi-kernel raspberrypi-kernel-headers</pre>
<p>En principe wiringPi est maintenant livré en standard, mais la version
incluse dans le système ne supporte pas forcément correctement le Pi 4.
Taper&#8239;:</p>
<pre class="term">gpio -v</pre>
<p>Si la commande ne peut être trouvée ou que la version indiquée est
antérieure à 2.52, il faut installer manuellement la dernière
version&#8239;:</p>
<!-- pre class="term">cd /tmp
wget https://project-downloads.drogon.net/wiringpi-latest.deb
sudo dpkg -i wiringpi-latest.deb
gpio -v</pre -->
<pre class="term">cd /tmp
git clone https://github.com/WiringPi/WiringPi.git
cd WiringPi
./build
gpio -v</pre>
<p>Encore une fois, s’assurer que la version est bien 2.52 ou postérieure.</p>



<h3><a id="soft-install-clang"></a>Installation de Clang (faculatif)</h3>

<p>Il est possible d’installer une verion récente de la suite de compilation
Clang.
Cette étape est facultative, mais Clang permet une accélération substantielle
(environ +25&#8239;% selon mes mesures) du programme Pédale Vite par rapport à
GCC, le compilateur installé par défaut.
Ici, nous allons installer Clang 13.0.0, la dernière version en date, mais il
est probable que des versions plus récentes soient
<a href="http://releases.llvm.org">disponibles</a> à l’heure où vous lisez
ces lignes.
Si c’est le cas, remplacer le <code>13.0.0</code> à la première des lignes
suivantes par le numéro de version en question.
Il est aussi possible de rester sur Clang 13.0.0, qui conviendra très bien.</p>
<p>Vérifier au préalable qu’il y a suffisamment d’espace sur le disque si
celui-ci est de faible capacité&#8239;: installer Clang nécessite environ
3&#8239;Go de libre.</p>
<pre class="term">clangversion="13.0.0"
cd ~
wget https://github.com/llvm/llvm-project/releases/download/llvmorg-$clangversion/clang+llvm-$clangversion-armv7a-linux-gnueabihf.tar.xz
tar -xvf clang+llvm-$clangversion-armv7a-linux-gnueabihf.tar.xz
rm clang+llvm-$clangversion-armv7a-linux-gnueabihf.tar.xz
mv clang+llvm-$clangversion-armv7a-linux-gnueabihf clang_$clangversion
sudo mv clang_$clangversion /usr/local
echo 'export PATH=/usr/local/clang_'$clangversion'/bin:$PATH' >> .bashrc
echo 'export LD_LIBRARY_PATH=/usr/local/clang_'$clangversion'/lib:$LD_LIBRARY_PATH' >> .bashrc
. .bashrc
clang++ --version</pre>
<p>La partie commençant par <code>wget</code> et finissant par <code>.xz</code>
tient sur une seule ligne.
En principe, tout devrait marcher correctement, cependant j’ai eu des
problèmes à lancer des exécutables utilisant la libc++ intégrée à Clang, qui
n’était pas trouvée.
Les lignes suivantes pallieront le problème&#8239;:</p>
<pre class="term">echo '/usr/local/clang_'$clangversion'/lib/' > ./clang.conf
sudo mv ./clang.conf /etc/ld.so.conf.d/
sudo ldconfig</pre>



<h3><a id="soft-install-app"></a>Installation de Pédale Vite</h3>

<p>On commence par télécharger le code dans <code>~/Documents</code>.</p>
<pre class="term">cd ~
mkdir Documents
cd Documents
git clone https://github.com/EleonoreMizo/pedalevite.git</pre>
<p>Configuration du projet&#8239;:</p>
<pre class="term">cd pedalevite/build/unix
./autogen.sh
./configure-v2-release</pre>
<p>Si Clang a été installé à l’étape précédente, remplacer la dernière
ligne par&#8239;:</p>
<pre class="term">./configure-v2-release --enable-clang</pre>
<p>Finalement (on reprend le tonc commun), on compile&#8239;:</p>
<pre class="term">make -j4</pre>
<p>Vérifier que tout s’est bien passé et qu’il y a un exécutable
<code>pedalevite</code> dans le répertoire courant.
On installe ensuite le logiciel dans son répertoire, ainsi que quelques autres
fichiers&#8239;:</p>
<pre class="term">sudo mkdir -p /opt/pedalevite/bin
sudo mkdir -p /opt/pedalevite/etc/config
sudo mkdir -p /opt/pedalevite/etc/font
sudo mkdir -p /opt/pedalevite/var/audiodump
sudo cp ./pedalevite /opt/pedalevite/bin/pedalevite
sudo cp ../../bin/cmd_rofs.sh /opt/pedalevite/bin/cmd_rofs.sh
sudo cp ../../etc/font/* /opt/pedalevite/etc/font</pre>
<p>Le Pi peut éventuellement être connecté à toutes les cartes et
périphériques nécessaires (cf. les instructions de montage).
Une fois ceci fait, on peut lancer Pédale Vite pour tester&#8239;:</p>
<pre class="term">sudo /opt/pedalevite/bin/pedalevite</pre>
<p>Le programme doit se mettre en route et tourner normalement.
<code>Ctrl+C</code> pour l’interrompre, ou le quitter via les menus de
l’interface d’utilisation.</p>



<h3><a id="soft-autorun"></a>Démarrage automatique de Pédale Vite</h3>

<p>Créer le fichier&#8239;:</p>
<pre class="term">sudo nano /etc/init.d/pedalevite</pre>
<p>Lui ajouter le contenu suivant&#8239;:</p>
<pre class="term">#!/bin/sh
# kFreeBSD do not accept scripts as interpreters, using #!/bin/sh and sourcing.
if [ true != "$INIT_D_SCRIPT_SOURCED" ] ; then
    set "$0" "$@"; INIT_D_SCRIPT_SOURCED=true . /lib/init/init-d-script
fi
### BEGIN INIT INFO
# Provides:          pedalevite
# Required-Start:    $local_fs
# Required-Stop:     $local_fs
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Starts and stops Pedale Vite
# Description:       This service is used to process the sound from a guitar
### END INIT INFO

case "$1" in
    start)
        echo "Mounting Pedale Vite directory as R/W..."
	mount --bind /opt/pedalevite/ /opt/pedalevite/
	mount -o remount,rw /opt/pedalevite/
        echo "Starting Pedale Vite..."
        /opt/pedalevite/bin/pedalevite &
        echo -n performance | sudo tee /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor > /dev/null
        echo -1 | sudo tee /proc/sys/kernel/sched_rt_runtime_us > /dev/null
        systemctl stop getty@tty1.service
        ;;
    stop)
        echo "Stopping Pedale Vite..."
        killall pedalevite
        umount /opt/pedalevite/
        ;;
    *)
        echo "Usage: /etc/init.d/pedalevite start|stop"
        exit 1
        ;;
esac

exit 0</pre>
<p>Puis&#8239;:</p>
<pre class="term">sudo chmod +x /etc/init.d/pedalevite
sudo update-rc.d pedalevite defaults</pre>
<p>Pédale Vite se lancera automatiquement au prochain démarrage du Pi.
Il peut être lancé immédiatement&#8239;:</p>
<pre class="term">sudo /etc/init.d/pedalevite start</pre>



<h3><a id="soft-ro"></a>Passage du système en lecture seule et autres optimisations</h3>

<p>Cette partie doit être traitée consciencieusement afin de ne pas laisser le
système dans un état incohérent.</p>

<h4>Script de retour au mode lecture-écriture</h4>

<p>Commencer par ajouter un petit script qui permettra de revenir facilement à
un système en lecture et écriture par la suite.
L’exécution manuelle de ce script sera impérative avant toute mise à jour,
compilation ou autres opérations de maintenance nécessitant un accès en
écriture au disque.</p>
<pre class="term">cd ~
nano fs-rw.sh</pre>
<p>Ajouter dans ce nouveau fichier&#8239;:</p>
<pre class="term">#!/bin/sh
sudo mount -o remount,rw /
sudo mount -o remount,rw /boot</pre>
<p>Lui donner les permissions d’exécution&#8239;:</p>
<pre class="term">chmod +x ./fs-rw.sh</pre>

<h4>Plat principal</h4>

<p>Retirer les choses qui ne sont pas nécessaire ni même adaptées
à des opérations en lecture seule:</p>
<pre class="term">sudo apt-get remove -y --force-yes --purge triggerhappy logrotate \
    dphys-swapfile fake-hwclock
sudo apt-get -y --force-yes autoremove --purge</pre>
<p>Installer busybox syslog à la place de rsyslog&#8239;:</p>
<pre class="term">sudo apt-get -y --force-yes install busybox-syslogd
sudo dpkg --purge rsyslog</pre>

<p>On édite les paramètres de boot&#8239;:</p>
<pre class="term">sudo nano /boot/cmdline.txt</pre>
<p>Ajouter
<code>fsck.mode=skip noswap ro logo.nologo</code>
tout à la fin de la
ligne (il n’y en a qu’une seule dans le texte qui suit)&#8239;:</p>
<pre class="term">dwc_otg.lpm_enable=0 console=serial0,115200 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait <span class="termhl">fsck.mode=skip noswap ro logo.nologo</span></pre>

<p>Remplacer certains sous-répertoires de <code>var</code> par des liens
symboliques sur le lecteur RAM&#8239;:</p>
<pre class="term">sudo rm -rf /var/spool
sudo ln -s /tmp /var/spool
sudo rm -rf /var/lib/lightdm /var/cache/lightdm
sudo ln -s /tmp /var/lib/lightdm
sudo ln -s /tmp /var/cache/lightdm</pre>

<p>Éditer <code>var.conf</code>&#8239;:</p>
<pre class="term">sudo nano /usr/lib/tmpfiles.d/var.conf</pre>
<p>Remplacer la permission du spool <code>0755</code> par
<code>1777</code>&#8239;:</p>
<pre class="term">d /var/spool <span class="termhl">1777</span> - - -</pre>

<p>Déplacer <code>dhcpd.resolv.conf</code> dans <code>tmpfs</code>&#8239;:</p>
<pre class="term">sudo touch /tmp/dhcpcd.resolv.conf
sudo rm /etc/resolv.conf
sudo ln -s /tmp/dhcpcd.resolv.conf /etc/resolv.conf</pre>

<p>Éditer <code>fstab</code>&#8239;:</p>
<pre class="term">sudo nano /etc/fstab</pre>
<p>Ajouter <code>,ro</code> après les defaults pour les partitions du
disque&#8239;:</p>
<pre class="term">proc            /proc           proc    defaults             0       0
/dev/mmcblk0p1  /boot           vfat    defaults<span class="termhl">,ro</span>          0       2
/dev/mmcblk0p2  /               ext4    defaults<span class="termhl">,ro</span>,noatime  0       1</pre>
<p>Il se peut que ces lignes commencent par <code>PARTUUID=</code>.
Ajouter également les ligne&#8239;:</p>
<pre class="term">tmpfs           /tmp            tmpfs   nosuid,nodev         0       0
tmpfs           /var/lib/systemd/timesync tmpfs   nosuid,nodev         0       0
tmpfs           /var/log        tmpfs   nosuid,nodev         0       0
tmpfs           /var/tmp        tmpfs   nosuid,nodev         0       0</pre>

<p>Éditer <code>rc.local</code>&#8239;:</p>
<pre class="term">sudo nano /etc/rc.local</pre>
<p>Ajouter le <code>chmod</code> avant le <code>exit 0</code>&#8239;:</p>
<pre class="term">  printf "My IP address is %s\n" "$_IP"
fi

<span class="termhl">chmod g+w,o+w /tmp</span>
exit 0</pre>

<p>Retirer les tentatives de mise à jour automatiques&#8239;:</p>
<pre class="term">sudo systemctl disable apt-daily.timer
sudo systemctl disable apt-daily-upgrade.timer
sudo systemctl disable man-db.timer</pre>

<p>Facultatif&#8239;: pour rebasculer automatiquement en lecture seule quand
on se déconnecte, éditer ou créer le fichier&#8239;:</p>
<pre class="term">sudo nano /etc/bash.bash_logout</pre>
<p>Ajouter les lignes suivantes à la fin&#8239;:</p>
<pre class="term">mount -o remount,ro /
mount -o remount,ro /boot</pre>

<p>Redémarrer.
Pédale Vite est à présent opérationnel.</p>



<h2><a id="maintenance"></a>V.&emsp;Maintenance</h2>

<h3><a id="troubleshooting"></a>Tests et dépannage</h3>

<p>À venir…</p>

<h4>Problèmes connus</h4>

<h5>Réseau non disponible</h5>

<p>Pour une raison inconnue, le système n’arrive pas à se connecter au réseau
au démarrage.
En général, un redémarrage règle le problème.</p>

<h5>Le programme Pédale Vite refuse de redémarrer après un crash</h5>

<p>Quand Pédale Vite se lance, il crée un fichier temporaire indiquant qu’une
instance du programme est lancée, ce qui empêche de lancer plusieurs instances
à la fois.
Ce fichier est supprimé quand Pédale Vite se termine, normalement ou par
<span class="keya">Ctrl</span>&nbsp;+ <span class="keya">C</span>.
Cependant en cas de crash, le fichier n’est pas effacé et Pédale Vite se
termine immédiatement en affichant&#8239;:<p>
<pre class="term">Pedale Vite is already running!</pre>
<p>Il suffit de le supprimer manuellement&#8239;:</p>
<pre class="term">sudo rm /var/lock/pedalevite-unique</pre>

<h5>Au démarrage, la mise à jour de l’EEPROM du RPi4 échoue</h5>

<p>Ce problème peut arriver pendant les démarrages qui suivent une mise à jour
du système.
La cause de l’erreur est le fonctionnement en lecture seule du système de
fichiers.
Pour y remédier, il suffit de passer le système en lecture-écriture et de
forcer la mise à jour&#8239;:</p>
<pre class="term">sudo mount -o remount,ro /
sudo mount -o remount,ro /boot
sudo systemctl restart rpi-eeprom-update.service</pre>
<p>On peut vérifier que l’opération s’est bien passée&#8239;:</p>
<pre class="term">sudo systemctl status rpi-eeprom-update.service</pre>

<h5>La date n’est pas mise à jour quand la machine est connectée à internet</h5>

<p>Quand bien même correctement configuré, <code>timesyncd</code> peut avoir
des difficultés à se connecter à un serveurs NTP.
Cela peut arriver après une mise à jour.
Commencer par passer le disque en lecture/écriture&#8239;:</p>
<pre class="term">sudo mount -o remount,rw /</pre>
<p>Vérifier les paramètres de synchronisation de la date avec la commande
suivante&#8239;:</p>
<pre class="term">timedatectl status</pre>
<p><code>NTP service</code> doit être sur <code>active</code>.
Si ce n’est pas le cas, tapez&#8239;:</p>
<pre class="term">sudo timedatectl set-ntp 1</pre>
<p>Revérifier en répétant la commande d’avant.
Dans tous les cas, il est possible que
<code>System clock synchronized</code> soit coincé sur <code>no</code>,
ce qui indique un problème d’accès aux serveurs NTP.
Dans ce cas&#8239;:</p>
<pre class="term">timedatectl timesync-status</pre>
<p>indique&#8239;:</p>
<pre class="term">       Server: (null) (3.debian.pool.ntp.org)
Poll interval: 0 (min: 32s; max 34min 8s)
 Packet count: 0</pre>
<p>Cela peut venir d’un problème avec les serveurs DNS (par exemple ceux
attribués par défaut par le fournisseur d’accès internet) qui ne résolvent pas
les adresses de serveurs NTP, pour je ne sais quelles raisons.
On peut essayer de fixer d’autres DNS explicitement:</p>
<pre class="term">sudo rm /etc/resolv.conf
sudo nano /etc/resolv.conf</pre>
<p>Ajouter les lignes suivantes.
Vous pouvez y mettre n’importe quelle adresse de serveur DNS qui
fonctionne&#8239;:</p>
<pre class="term">domain home
nameserver 80.67.169.12
nameserver 80.67.169.40</pre>
<p>Redémarrer la machine ou seulement les services adéquats.</p>
<p><strong>Note importante&#8239;:</strong> il peut être nécessaire de refaire cette
opération après une mise à jour du système.</p>

<h5>Le son clique ou les canaux s’inversent régulièrement</h5>

<p>Il s’agit probablement d’un problème lié à la répartition du temps pour les
threads temps-réels.
Enter les commandes suivantes et examiner leur résultat&#8239;:</p>
<pre class="term">cat /proc/sys/kernel/sched_rt_period_us
cat /proc/sys/kernel/sched_rt_runtime_us</pre>
<p>La valeur de <code>runtime</code> devrait être égale à celle de
<code>period</code>, ou alors <code>-1</code>.
Si ce n’est pas le cas, exécuter la commande suivante&#8239;:</p>
<pre class="term">echo -1 | sudo tee /proc/sys/kernel/sched_rt_runtime_us > /dev/null</pre>

<h3><a id="source-code"></a>Code source</h3>

<p>Bien que le matériel tienne une place de choix dans Pédale Vite,
il s’agit quand même essentiellement d’un projet logiciel.
Cette partie décrit succintement l’architecture du programme ainsi que ce
qu’il faut savoir pour l’adapter facilement à des modifications du 
matériel.
Pour mettre à jour le code depuis le dépôt Git&#8239;:</p>
<pre class="term">cd ~/Documents/pedalevite
git pull</pre>
<p>Sans oublier auparavant de passer le système en lecture-écriture avec&#8239;:</p>
<pre class="term">~/fs-rw.sh</pre>

<h4>Compilation</h4>

<p>Le logiciel est écrit en C++.
Le compilateur doit supporter C++14 au minimum.
Les fichiers de projet se trouvent dans le répertoire
<code>pedalevite/build</code>.</p>

<h5>Linux</h5>

<p>Le sous-répertoire <code>unix</code> contient ce qu’il faut pour compiler
sur le Pi et à destination du Pi.
<code>Makefile.am</code> est le fichier à modifier pour ajouter les fichiers
source.
<code>configure-v2-debug</code> et <code>configure-v2-release</code>
permettent de choisir la configuration de compilation.
Un coup de <code>make -j4</code> recompile le projet.
<code>make check -j4</code> permet de recompiler en plus le programme des
tests unitaires (à configurer auparavant).
Voir aussi les instructions d’installation logicielle.</p>

<h5>Windows</h5>

<p><code>win</code> contient les projets pour Visual Studio 2019.
Les sources sont divisées en plusieurs catégories&#8239;:</p>
<ul>
<li><code>mfxlib</code> est un projet regroupant la plupart des sources
sous forme de bibliothèque statique.
C’est une entité partagée entre les autres projets.</li>
<li><code>pedalevite</code> est un programme émulant le pédalier avec une
carte son ASIO, le clavier et l’écran de l’ordinateur.
Ce programme est de loin la manière la plus simple de modifier et tester le
logiciel de Pédale Vite.</li>
<li><code>test</code> contient quelques tests unitaires de classes ou de
fonctionnalités diverses.</li>
</ul>
<p>Ces trois projets sont intégrés dans la solution
<code>pedalevite.sln</code>.</p>
<p>Si la carte son de votre machine n’a pas de drivers ASIO, il est tout
à fait possible de faire tourner <a href="www.asio4all.com">ASIO4ALL</a>.
Par défaut les canaux d’entrée de l’émulateur Pédale Vite sont les numéros
3 et 4 (ce sont les entrées niveau instrument de ma carte).
Il vous faudra probablement les changer en modifiant la valeur de
<code>chn_idx_in</code> vers la fin de
<code>pedalevite/src/main.cpp</code>&#8239;:</p>
<pre class="src">#elif (MAIN_API == MAIN_API_ASIO)
	mfx::adrv::DAsio  snd_drv;
	chn_idx_in = 2;
#else</pre>
<p>L’émulation utilise les touches suivantes&#8239;:</p>
<table>
<tr><td><span class="key">A Z E R T Y</span> ou <span class="key">Q W E R T Y</span></td><td>Pédales 0 à 5, rangée du haut</td></tr>
<tr><td><span class="key">Q S D F G H</span> ou <span class="key">A S D F G H</span></td><td>Pédales 6 à 11, rangée du bas</td></tr>
<tr><td><span class="key">0 1 2</span>… <span class="key">8 9</span> du pavé numérique</td><td>Différentes valeurs pour la pédale d’expression 0</td></tr>
<tr><td><span class="key">1 2</span>,<br /><span class="key">3 4</span>,<br />… …,<br /><span class="key">9 0</span></td><td>&minus;1 et +1 des 5 codeurs incrémentaux</td></tr>
<tr><td><span class="key">W X C</span> ou <span class="key">Z X C</span> et<br /><span class="key">V B N</span></td><td>&minus;1, +1 et bouton des 2 codeurs incrémentaux de navigation</td></tr>
<tr><td><span class="key">Return</span></td><td><span class="key">Select</span> de l’interface d’utilisation</td></tr>
<tr><td><span class="key">Esc</span></td><td><span class="key">Esc</span> de l’interface d’utilisation</td></tr>
<tr><td>Flèches directionnelles</td><td>Flèches de l’interface d’utilisation</td></tr>
</table>

<h4>Architecture</h4>

<h5>Threads</h5>

<p>Le programme se répartit grosso-modo en 3 threads&#8239;:</p>
<ul>
<li>Le thread audio qui traite tout ce qui est entrées et sorties audio, et
qui calcule ce qu’il faut entre les deux.</li>
<li>Le thread principal, qui collecte les entrées de contrôle et émet les
données à afficher.
C’est lui qui gère toutes les interactions de l’interface d’utilisation et
qui contrôle le thread audio.</li>
<li>Enfin, le ou les (en fonction de la plateforme) threads E/S.
Ils recueillent régulièrement les états des ports d’entrée et redirigent les
informations d’affichage vers les périphériques adéquats.</li>
</ul>
<p>Les threads communiquent entre eux à l’aide de files non-bloquantes
(<span lang="en"><i>lock-free queues</i></span>).
La plupart des informations sont centralisées par le thread principal,
cependant certaines communications ont lieu directement entre le thread
des entrées et le thread audio, afin de maximiser la réactivité du
traitement sonore face aux sollicitations extérieures.</p>

<h5>Paradigme MVC</h5>

<p>L’architecture suit le paradigme MVC
(<span lang="en"><i>Model-View-Controller</i></span>).
Le modèle <code>mfx::Model</code> pilote une partie bas-niveau de commande du
moteur audio <code>mfx::cmd::Central</code>.
Les données y sont préparées, toujours dans le thread principal, et
communiquées de manière transactionnelle au thread audio dont l’essentiel se
trouve dans <code>mfx::WorldAudio</code>.</p>
<p>La structure du document (banques, programmes, réglages divers…) est
décrite dans <code>mfx::doc</code>.
Le fichier de sauvegarde <code>etc/config/current</code> est directement
généré et lu par l’interface de sérialisation.</p>
<p>Les différents drivers audio se trouvent dans <code>mfx::adrv</code>.
Le gros du code spécifique à la plate-forme se trouve dans
<code>mfx::hw</code>.
C’est dans ces classes qu’on peut changer la polartié des interrupteurs,
leur ordre, les numéros de broche GPIO, la vitesse des interfaces de
communication et tout autre détail relevant du matériel.</p>
<p>L’interface d’utilisation se décompose sous forme de pages dans
<code>mfx::uitk::pg</code>.
Ces pages sont activées en fonction de la navigation de l’utilisateur·ice.
Elles sont enregistrées comme vues et agissent comme contrôleur, au sens
MVC.
Elles utilisent un système sommaire de GUI arborescente implémenté dans
<code>mfx::uitk</code>, permettant de placer des contrôles, de recevoir
des événements d’utilisation et de naviguer simplement dans ces éléments.</p>
<p>Les effets sont organisés dans <code>mfx::pi</code> selon une logique de
<span lang="en"><i>plug-in</i></span>, bien que celle-ci ne soit pas encore
déployée comme telle.
L’interface commune se trouve dans <code>mfx::piapi</code>.
Chaque effet est en fait divisé en deux plug-ins.
D’une part l’effet proprement dit, d’autre part un plug-in de mixage
implémentant le bypass, le volume et le mélange dry/wet.</p>
<p>Toutes ces pièces sont scotchées ensemble dans
<code>pedalevite/src/mfx/main.cpp</code> qui a une forme encore très
brouillonne.
L’essentiel du paramétrage figure dans <code>mfx::Cst</code>.</p>
<p>Il y aurait bien d’autres choses à dire sur l’architecture du code et les
détails d’implémentation, cependant c’est une tâche sans fin.
Cette section sera éventuellement étoffée plus tard.</p>

<h4>Arborescence</h4>

<p>L’arborescence des sources dans <code>pedalevite/src</code> suit
relativement précisément celle des namespaces.
Les classe sont implémentées dans des fichiers qui portent leur nom, à
l’instar de la convention en Java.
Notons les namespaces suivants&#8239;:</p>
<ul>
<li><code>fstb</code> est une sorte de boîte à outils générique.
Elle fournit diverses fonctions et outils de bases.
Il y a en particulier un wrapper sur les jeux d’instruction SIMD 128 bits
SSE/SSE2 et NEON permettant d’écrire sans difficulté du code portable.</li>
<li><code>conc</code> fournit des primitives pour la communication
non bloquante.</li>
<li><code>mfx::dsp</code> contient de nombreuses classes de traitement
du signal audio (filtrage, mixage, lignes à retard…)
Cette bibliothèque est abondamment utilisée par les effets.</li>
</ul>
<p><code>pedalevite/etc/config</code> contient les configurations du
pédalier (en particulier <code>current</code>).
Ce répertoire est copié dans le lieu d’installation
<code>/opt/pedalevite</code> sur le Pi et utilisé <i>in-situ</i>
par l’émulateur Windows.</p>



<h2><a id="improvements"></a>VI.&emsp;Amérliorations et variations envisageables</h2>

<p>Pour les personnes que la complexité ou le prix rebutte, il y a de
nombreuses façons de réduire les coûts ou de simplifier le montage.
Voici quelques unes de celles qui me sont passées par la tête.</p>

<h4>Carte son USB à l’extérieur</h4>

<p>Il y a de nombreux avantages&#8239;:</p>
<ul>
<li>Réduction des coûts par la suppression de la carte et de la connectique
audio interne.</li>
<li>Simplification du montage pour les mêmes raisons.</li>
<li>Accès direct aux réglages en façade pour calibration.</li>
<li>Permet de changer de modèle de carte son sans se prendre la tête sur des questions géométriques.</li>
</ul>
<p>En terme d’inconvénients&#8239;:</p>
<ul>
<li>Plus d’éléments à trimbaler, connexions plus complexes lors de l’utilisation.</li>
<li>Complexité encore ajoutée si on alimente séparément la carte au lieu d’utiliser l’USB.</li>
<li>Il faut un peu changer la configuration logicielle (drivers ALSA).</li>
</ul>

<h4>Simplification de la carte son interne</h4>

<p>Il est tout à fait possible de se passer des préamplificateurs micro si on
sait qu’on ne va pas en avoir l’usage, voire de se passer complètement du
deuxième canal d’entrée.
Cela diminue significativement le nombre de composants sur la carte.</p>

<h4>Matériaux moins coûteux</h4>

<p>On peut déjà optimiser les prix en choisissant des fournisseurs plus
avantageux.
Ça demande de faire une recherche un peu exhaustive et de vérifier la
compatibilité des pièces si celles-ci diffèrent de celles suggérées.</p>
<p>Par exemple, la connectique audio pourrait utiliser des jack TR (mono)
d’entrée de gamme au lieu des combo jack/XLR Neutrik et des prises jack
TRS (stéréo).</p>
<p>Par contre je pense qu’il serait maladroit d’essayer d’économiser sur les
interrupteurs au pied.
La solidité de ces composants est primordiale.</p>

<h4>Suppression des codeurs incrémentaux</h4>

<p>Dans la configuration actuelle, je ne les utilise pas aussi souvent que je
l’imaginais. 
Je pense qu’on peut s’en passer sans problème.
Cela fait de la connectique et des coûts en moins.</p>

<h4>Substitution des résistances de tirage</h4>

<p>Le RPi ainsi que les extenseurs de ports 23017 disposent de résistances
interne de tirage.
On peut les utiliser à la place de la myriade de 10&#8239;kΩ et faire sauter
au passage les condensateurs anti-rebond qui vont avec.
Ça donnera quelque chose d’électriquement un peu moins propre, mais qui
devrait tenir la route.
Le code à changer pour activer ces résistances dans les puces est minime.
Le lissage des rebonds est déjà doublé en software et ne devrait pas
nécessiter de changement.</p>
<p>Il y a peu à gagner en terme de coûts, les résistances et condensateurs
céramiques étant bon marché.
Cependant la simplification des circuits est significative.</p>

<h4>Réduction du nombre de connecteurs</h4>

<p>La plupart des liaisons entre les cartes et composants principaux sont
faites au moyen de câbles terminés par des connecteurs aux deux bouts.
On peut s’en affranchir de certains et les remplacer par de la soudure
simple.
Toutefois je déconseille de souder les câbles aux deux bouts, la maintenance
et le contrôle s’en trouveraient grandement réduits.</p>
<p>D’autre part, comme beaucoup de fils voyagent ensemble, il est aussi
possible de prendre de la nappe et de tailler des morceaux dedans afin
d’avoir des groupes de fils déjà solidaires.
Un bon mètre de nappe multicolore 40 fils devrait suffire pour l’ensemble du
montage.
Attention tout de même, le diamètre du fil de nappe est souvent assez
faible et peut être limite pour le brochage Dupont.
Mais peut-être que d’autres types de connecteurs seront plus adaptés.</p>



<h2><a id="changelog"></a>VII.&emsp;Historique des versions</h2>

<p><b>r9, 2021-03-26</b></p>
<ul>
<li>jouts dans la section des diagnostics concernant la fraction de temps
attribuée aux threads temps-réels.</li>
</ul>

<p><b>r8, 2020-10-02</b></p>
<ul>
<li>Ajouts dans la section des diagnostics.</li>
<li>Mise à jour de l’installation de Clang en version 11.0.0</li>
</ul>

<p><b>r7, 2020-03-03</b></p>
<ul>
<li>Mise à jour du passage en lecture seule du système de fichiers.</li>
</ul>

<p><b>r6, 2020-01-16</b></p>
<ul>
<li>Ajout de la création de quelques sous-répertoires lors de l’installation
logicielle.</li>
</ul>

<p><b>r5, 2019-12-20</b></p>
<ul>
<li>Utilisation possible de Clang pour compiler Pédale Vite.</li>
</ul>

<p><b>r4, 2019-11-09</b></p>
<ul>
<li>Résolution de problèmes de dates lors de la mise en lecture seule du
système de fichiers.</li>
</ul>

<p><b>r3, 2019-11-07</b></p>
<ul>
<li>Mise à jour du script de démarrage automatique pour passer le
sous-répertoire /opt/pedalevite en lecture-écriture.</li>
</ul>

<p><b>r2, 2019-11-02</b></p>
<ul>
<li>Passage à la version 2 de Pédale Vite.</li>
</ul>

<p><b>r1, 2017-09-24</b></p>
<ul>
<li>Reformulations et mises à jour mineures.</li>
</ul>

<p><b>r0, 2016-12-31</b></p>
<ul>
<li>Création du document.</li>
</ul>



<p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p>

</div></body>
</html>


